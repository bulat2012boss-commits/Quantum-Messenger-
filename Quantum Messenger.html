<!DOCTYPE html>
<html lang="ru">
<head>    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Quantum Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="animations.css">
<!-- После основного скрипта -->
<script src="profile-color.js"></script>
<!-- Новые функции для мессенджера -->
<script src="image-upload.js"></script>
<script src="gallery-viewer.js"></script>
<script src="image-editor.js"></script>
<script src="screenshot-tool.js"></script>
<!-- Подключаем систему каналов -->
<link rel="stylesheet" href="channels.css">
<script src="channels.js"></script>
<script src="channels-integration.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-bg: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            --message-bg: linear-gradient(to right, #4facfe, #00f2fe);
            --text-color: #fff;
            --input-bg: rgba(255, 255, 255, 0.9);
            --input-color: #333;
            --other-msg-bg: rgba(255, 255, 255, 0.15);
            --header-bg: rgba(0, 0, 0, 0.3);
            --online-bg: rgba(0, 0, 0, 0.2);
            --system-msg-bg: rgba(0, 0, 0, 0.3);
            --border-color: rgba(255, 255, 255, 0.1);
            --action-btn-bg: rgba(160, 210, 235, 0.2);
            --action-btn-color: #a0d2eb;
            --search-bg: rgba(0, 0, 0, 0.15);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            --profile-bg: rgba(0, 0, 0, 0.5);
            --gift-bg: rgba(255, 215, 0, 0.15);
            --nft-bg: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
        }
        
        .light-theme {
            --primary-bg: linear-gradient(135deg, #f5f7fa, #e4e7eb, #f1f3f6);
            --message-bg: linear-gradient(to right, #4facfe, #00f2fe);
            --text-color: #2d3748;
            --input-bg: #ffffff;
            --input-color: #2d3748;
            --other-msg-bg: #ffffff;
            --header-bg: #ffffff;
            --online-bg: rgba(0, 0, 0, 0.05);
            --system-msg-bg: rgba(0, 0, 0, 0.07);
            --border-color: rgba(0, 0, 0, 0.1);
            --action-btn-bg: rgba(160, 210, 235, 0.3);
            --action-btn-color: #2b6cb0;
            --search-bg: rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --profile-bg: rgba(255, 255, 255, 0.9);
            --gift-bg: rgba(255, 215, 0, 0.25);
        }
        /* Добавь после .light-theme */
.sea-theme {
    --primary-bg: linear-gradient(135deg, #0a192f, #112240, #0a192f);
    --message-bg: linear-gradient(to right, #64ffda, #00ffcb);
    --text-color: #ccd6f6;
    --input-bg: rgba(17, 34, 64, 0.9);
    --input-color: #e6f1ff;
    --other-msg-bg: rgba(100, 255, 218, 0.15);
    --header-bg: rgba(10, 25, 47, 0.9);
    --online-bg: rgba(100, 255, 218, 0.1);
    --system-msg-bg: rgba(100, 255, 218, 0.2);
    --border-color: rgba(100, 255, 218, 0.3);
    --action-btn-bg: rgba(100, 255, 218, 0.2);
    --action-btn-color: #64ffda;
    --search-bg: rgba(17, 34, 64, 0.7);
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    --profile-bg: rgba(10, 25, 47, 0.95);
    --gift-bg: rgba(100, 255, 218, 0.2);
}

.halloween-theme {
    --primary-bg: linear-gradient(135deg, #1a1a1a, #2d1b00, #1a1a1a);
    --message-bg: linear-gradient(to right, #ff7600, #ff5100);
    --text-color: #ffaa44;
    --input-bg: rgba(45, 27, 0, 0.9);
    --input-color: #ffd700;
    --other-msg-bg: rgba(255, 118, 0, 0.15);
    --header-bg: rgba(26, 26, 26, 0.9);
    --online-bg: rgba(255, 118, 0, 0.2);
    --system-msg-bg: rgba(255, 118, 0, 0.3);
    --border-color: rgba(255, 118, 0, 0.4);
    --action-btn-bg: rgba(255, 118, 0, 0.2);
    --action-btn-color: #ff7600;
    --search-bg: rgba(45, 27, 0, 0.7);
    --shadow: 0 4px 20px rgba(255, 118, 0, 0.2);
    --profile-bg: rgba(26, 26, 26, 0.95);
    --gift-bg: rgba(255, 118, 0, 0.3);
}

.christmas-theme {
    --primary-bg: linear-gradient(135deg, #0d200c, #1a3c29, #0d200c);
    --message-bg: linear-gradient(to right, #ff3333, #ff6666);
    --text-color: #ffffff;
    --input-bg: rgba(26, 60, 41, 0.9);
    --input-color: #ffffff;
    --other-msg-bg: rgba(255, 51, 51, 0.15);
    --header-bg: rgba(13, 32, 12, 0.9);
    --online-bg: rgba(255, 51, 51, 0.2);
    --system-msg-bg: rgba(255, 51, 51, 0.3);
    --border-color: rgba(255, 51, 51, 0.4);
    --action-btn-bg: rgba(255, 51, 51, 0.2);
    --action-btn-color: #ff3333;
    --search-bg: rgba(26, 60, 41, 0.7);
    --shadow: 0 4px 20px rgba(255, 51, 51, 0.2);
    --profile-bg: rgba(13, 32, 12, 0.95);
    --gift-bg: rgba(255, 51, 51, 0.3);
}
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--primary-bg);
    z-index: -1;
    transform: translateZ(-10px) scale(2);
}
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        
        .header {
            padding: 12px 15px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .logo {
            margin-right: 8px;
            font-size: 22px;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .auth-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 8px;
            font-size: 16px;
            color: #a0d2eb;
        }
        
        .light-theme .auth-title {
            color: #2b6cb0;
        }
        
        .auth-container input {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .auth-container input:focus {
            border-color: #a0d2eb;
            box-shadow: 0 0 0 2px rgba(160, 210, 235, 0.2);
        }
        
        .auth-container input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .light-theme .auth-container input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }
        
        .auth-container button {
            padding: 12px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .auth-container button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .secret-code-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border-left: 3px solid #00f2fe;
            font-size: 14px;
        }
        
        .light-theme .secret-code-container {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .chat-wrapper {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 10px 12px;
            background: var(--header-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .user-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-controls {
            display: flex;
            gap: 6px;
            margin-left: auto;
        }
        
        .action-btn {
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: background 0.2s;
            background: var(--action-btn-bg);
            color: var(--action-btn-color);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .action-btn:hover {
            opacity: 0.9;
        }
        
        .logout-btn {
            background: rgba(160, 210, 235, 0.2);
            color: #a0d2eb;
        }
        
        .light-theme .logout-btn {
            background: rgba(160, 210, 235, 0.3);
            color: #2b6cb0;
        }
        
        .clear-chat-btn {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }
        
        .light-theme .clear-chat-btn {
            background: rgba(255, 100, 100, 0.3);
        }
        
        .online-count {
            text-align: center;
            padding: 8px;
            background: var(--online-bg);
            font-size: 12px;
            color: #a0d2eb;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .light-theme .online-count {
            color: #2b6cb0;
        }
        
        .admin-controls {
            display: flex;
            justify-content: center;
            gap: 6px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            color: #a0d2eb;
            flex-shrink: 0;
        }
        
        .light-theme .admin-controls {
            background: rgba(0, 0, 0, 0.05);
            color: #2b6cb0;
        }
        
        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0, 0, 0, 0.03);
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .light-theme .messages-wrapper {
            background: rgba(0, 0, 0, 0.01);
        }
        
        .message {
            max-width: 85%;
            padding: 10px 12px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            animation: messageAppearEnhanced 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .my-message {
            align-self: flex-end;
            background: var(--message-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .other-message {
            align-self: flex-start;
            background: var(--other-msg-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .sender {
            font-size: 11px;
            margin-bottom: 3px;
            color: #a0d2eb;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        
        .light-theme .sender {
            color: #2b6cb0;
        }
        
        .verified-badge {
            color: #00f2fe;
            font-size: 12px;
        }
        
        .developer-badge {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
            margin-left: 4px;
        }
        
        .tester-badge {
            background: linear-gradient(to right, #ff9a9e, #fad0c4);
            color: #333;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 9px;
            margin-left: 4px;
        }
        
        .timestamp {
            font-size: 9px;
            text-align: right;
            margin-top: 3px;
            opacity: 0.7;
        }
        
       
    /* ЗАМЕНИТЕ существующий стиль .message-actions на этот: */
    .message-actions {
        position: absolute;
        top: -15px;
        right: 10px;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 15px;
        padding: 5px;
        display: none; /* Изначально скрыты */
        gap: 5px;
        z-index: 5; /* Добавляем для верного отображения */
    }

    .message:hover .message-actions {
        display: flex; /* Показываем при наведении */
    }
        
        .message-action-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            padding: 3px;
        }
        
        .reactions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        
        .reaction {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .reaction:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .reaction.active {
            background: rgba(74, 144, 226, 0.5);
        }
        
        .light-theme .reaction {
            background: rgba(0, 0, 0, 0.1);
        }
        
        .light-theme .reaction:hover {
            background: rgba(0, 0, 0, 0.15);
        }
        
        .input-area {
            display: flex;
            padding: 12px;
            background: rgba(0, 0, 0, 0.05);
            gap: 8px;
            border-top: 1px solid var(--border-color);
            align-items: center;
            flex-shrink: 0;
        }
        
        .input-area input {
            flex: 1;
            padding: 12px;
            background: var(--input-bg);
            color: var(--input-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .input-area input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.2);
        }
        
        .input-area button {
            padding: 10px 15px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .input-area button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .voice-recorder {
            background: #ff6464;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            transition: transform 0.2s;
        }
        
        .voice-recorder:hover {
            transform: scale(1.05);
        }
        
        .voice-recorder.recording {
    animation: recordingPulse 1.5s infinite;
}
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 100, 100, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 100, 100, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 100, 100, 0);
            }
        }
        
        .system-message {
            align-self: center;
            background: var(--system-msg-bg);
            color: #a0d2eb;
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 10px;
            margin: 3px 0;
        }
        
        .light-theme .system-message {
            color: #2b6cb0;
        }
        
        .notification {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            animation: notificationFade 3s forwards;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes notificationFade {
            0% { opacity: 0; transform: translate(-50%, -10px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -10px); }
        }
        .notification.private {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    border-left: 4px solid #ff4757;
}

.notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: linear-gradient(to right, #4facfe, #00f2fe);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.notification-text {
    flex: 1;
}

.notification-action {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 10px;
}
        
        .search-container {
            padding: 10px;
            background: var(--search-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .search-container input {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        
        .search-container input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.2);
        }
        
        .search-container button {
            padding: 8px 15px;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .search-container button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .typing-indicator {
            padding: 5px 10px;
            font-size: 12px;
            color: #a0d2eb;
            font-style: italic;
            height: 20px;
            flex-shrink: 0;
        }
        
        .light-theme .typing-indicator {
            color: #2b6cb0;
        }
        
        .quote-container {
            background: rgba(0, 0, 0, 0.1);
            border-left: 3px solid #4facfe;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        
        .light-theme .quote-container {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .quote-author {
            font-weight: bold;
            font-size: 12px;
            color: #4facfe;
        }
        
        .quote-text {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--primary-bg);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }
        
        .avatar-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .avatar-option.selected {
            border-color: #4facfe;
            transform: scale(1.1);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        .modal-btn {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .modal-btn.primary {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
        }
        
        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
        
        .highlight {
            background: rgba(79, 172, 254, 0.3);
            padding: 2px 0;
            border-radius: 3px;
        }
        
        .voice-message-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .voice-message-btn {
            background: rgba(79, 172, 254, 0.2);
            border: none;
            border-radius: 15px;
            padding: 5px 10px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .voice-message-btn:hover {
            background: rgba(79, 172, 254, 0.3);
        }
        
        .loading {
            display: flex;
            justify-content: center;
            padding: 10px;
        }
        
        .loading-dots {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #a0d2eb;
            animation: loading 1.4s infinite ease-in-out both;
        }
        
        .light-theme .loading-dot {
            background: #2b6cb0;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes loading {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .emoji-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background: var(--header-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .emoji-btn {
            font-size: 20px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoji-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .user-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-left: 5px;
        }
        
        .user-status.offline {
            background: #ccc;
        }
        
        .message-menu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            padding: 5px;
            display: none;
            flex-direction: column;
            gap: 5px;
        }
        
        .message:hover .message-menu {
            display: flex;
        }
        
        .message-menu-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            color: #a0d2eb;
            text-align: center;
            padding: 20px;
        }
        
        .empty-chat i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .empty-chat p {
            font-size: 16px;
            max-width: 300px;
        }
        
        .light-theme .empty-chat {
            color: #2b6cb0;
        }
        
        .profile-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            overflow: hidden;
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: bold;
        }
        
        .profile-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .profile-info-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-info-label {
            font-weight: 500;
            opacity: 0.8;
        }
        
        .profile-info-value {
            font-weight: 600;
        }
        
        .profile-badges {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .profile-badge {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .badge-developer {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
        }
        
        .badge-tester {
            background: linear-gradient(to right, #ff9a9e, #fad0c4);
            color: #333;
        }
        
        .badge-vip {
            background: linear-gradient(to right, #a1c4fd, #c2e9fb);
            color: #333;
        }
        
        .badge-supporter {
            background: linear-gradient(to right, #a1c4fd, #c2e9fb);
            color: #333;
        }
        
        .badge-active {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
        }
        
        .badge-chatty {
            background: linear-gradient(to right, #ff9a9e, #fad0c4);
            color: #333;
        }
        
        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .profile-action-btn {
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .profile-action-btn.primary {
            background: linear-gradient(to right, #4facfe, #00f2fe);
            color: white;
        }
        
        .profile-action-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
        
        .profile-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        
        .light-theme .stat-card {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .activity-chart {
            width: 100%;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            align-items: flex-end;
            padding: 5px;
            gap: 2px;
        }
        
        .light-theme .activity-chart {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #4facfe, #00f2fe);
            border-radius: 2px;
            transition: height 0.3s ease;
        }
        
        .profile-section {
            width: 100%;
            margin-top: 15px;
        }
        
        .profile-section-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-note {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            resize: vertical;
            min-height: 60px;
            color: var(--text-color);
        }
        
        .light-theme .user-note {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .user-note:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .media-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .media-item {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .achievement-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .achievement-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .light-theme .achievement-item {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .achievement-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(to right, #4facfe, #00f2fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .achievement-info {
            flex: 1;
        }
        
        .achievement-title {
            font-weight: bold;
            font-size: 12px;
        }
        
        .achievement-desc {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 8px 15px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            opacity: 1;
            border-bottom: 2px solid #4facfe;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Стили для подарков */
        .gift-btn {
            background: #ffcc00;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            color: white;
            transition: transform 0.2s;
            font-size: 18px;
        }
        
        .gift-btn:hover {
            transform: scale(1.05);
        }
        
        .gift-message {
            background: var(--gift-bg);
            border-radius: 15px;
            padding: 10px;
            margin: 5px 0;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        
        .gift-message.nft {
            background: var(--nft-bg);
            color: white;
            border: none;
            animation: nftGlow 2s infinite alternate;
        }
        
        @keyframes nftGlow {
            from {
                box-shadow: 0 0 5px rgba(253, 29, 29, 0.5);
            }
            to {
                box-shadow: 0 0 15px rgba(253, 29, 29, 0.8), 0 0 30px rgba(252, 176, 69, 0.6);
            }
        }
        
        .gift-content {
            font-size: 32px;
            margin: 10px 0;
            animation: giftBounce 0.5s;
        }
        
        @keyframes giftBounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        
        .gift-sender {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .gift-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .gift-option {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        
        .gift-option:hover {
            transform: scale(1.1);
            border-color: #4facfe;
        }
        
        .gift-option.nft {
            background: var(--nft-bg);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .gift-option.nft::after {
            content: "NFT";
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 1px 3px;
            border-radius: 3px;
        }
        
        .gift-category {
            margin-bottom: 15px;
        }
        
        .gift-category h4 {
            margin-bottom: 8px;
            font-size: 14px;
            color: #a0d2eb;
        }
        
        .light-theme .gift-category h4 {
            color: #2b6cb0;
        }
        
        .gift-counter {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 3px;
        }
        
.game-btn:hover {
    transform: scale(1.05);
    background: #8e44ad;
}
        
        /* Новые стили для выбора получателя подарка */
        .gift-recipient {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
        }
        
        .recipient-select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            outline: none;
        }
        
        /* Стили для списка подарков в профиле */
        .gifts-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .gift-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            position: relative;
            transition: transform 0.2s;
        }
        
        .gift-item:hover {
            transform: scale(1.05);
        }
        
        .gift-item.nft {
            animation: nftPulse 3s infinite;
        }
        
        @keyframes nftPulse {
            0% {
                box-shadow: 0 0 5px rgba(253, 29, 29, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 20px rgba(253, 29, 29, 0.8), 0 0 30px rgba(252, 176, 69, 0.6);
                transform: scale(1.05);
            }
            100% {
                box-shadow: 0 0 5px rgba(253, 29, 29, 0.5);
                transform: scale(1);
            }
        }
        
        .gift-item-content {
            font-size: 24px;
            margin: 5px 0;
        }
        
        .gift-item-sender {
            font-size: 10px;
            opacity: 0.8;
            margin-bottom: 3px;
        }
        
        .gift-item-time {
            font-size: 9px;
            opacity: 0.6;
        }
        
        .gift-item-type {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 8px;
            background: rgba(0, 0, 0, 0.7);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        /* Анимация для особого NFT подарка - кубка */
        .trophy-gift {
            animation: trophySpin 5s infinite;
            transform-style: preserve-3d;
        }
        
        @keyframes trophySpin {
            0% {
                transform: rotateY(0deg) scale(1);
            }
            25% {
                transform: rotateY(90deg) scale(1.1);
            }
            50% {
                transform: rotateY(180deg) scale(1.2);
                text-shadow: 0 0 10px gold, 0 0 20px orange;
            }
            75% {
                transform: rotateY(270deg) scale(1.1);
            }
            100% {
                transform: rotateY(360deg) scale(1);
            }
        }
        
        /* Эмодзи-панель */
        .emoji-panel-container {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background: var(--header-bg);
            border-radius: 10px;
            padding: 10px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: none;
        }
        
        .emoji-panel-container.active {
            display: block;
        }
        
        .emoji-category {
            margin-bottom: 10px;
        }
        
        .emoji-category-title {
            font-size: 12px;
            margin-bottom: 5px;
            color: #a0d2eb;
        }
        
        .light-theme .emoji-category-title {
            color: #2b6cb0;
        }
        
        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .header {
                padding: 10px;
                font-size: 18px;
            }
            
            .auth-container {
                padding: 15px;
                margin: 20px auto;
                width: 95%;
            }
            
            .chat-header {
                padding: 8px 10px;
                font-size: 12px;
                flex-wrap: wrap;
            }
            
            .action-btn {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .action-btn span {
                display: none;
            }
            
            .message {
                max-width: 90%;
                font-size: 13px;
                padding: 8px 10px;
            }
            
            .input-area {
                padding: 10px;
            }
            
            .input-area input {
                padding: 10px;
                font-size: 13px;
            }
            
            .input-area button {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .input-area button span {
                display: none;
            }
            
            .avatar-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .avatar-option {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .online-count, .admin-controls {
                font-size: 11px;
                padding: 6px;
            }
            
            .profile-avatar {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }
            
            .profile-name {
                font-size: 18px;
            }
            
            .profile-stats {
                grid-template-columns: 1fr;
            }
            
            .media-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .gift-options {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .gift-option {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .gifts-list {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .emoji-panel-container {
                bottom: 60px;
                right: 5px;
                left: 5px;
            }
            
            .emoji-btn {
                width: 35px;
                height: 35px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                font-size: 16px;
            }
            
            .auth-container {
                margin: 15px auto;
                padding: 12px;
            }
            
            .auth-title {
                font-size: 14px;
            }
            
            .auth-container input {
                padding: 10px;
                font-size: 14px;
            }
            
            .auth-container button {
                padding: 10px;
                font-size: 14px;
            }
            
            .secret-code-container {
                font-size: 12px;
                padding: 8px;
            }
            
            .user-name {
                font-size: 13px;
            }
            
            .messages-wrapper {
                padding: 8px;
                gap: 8px;
            }
            
            .voice-recorder, .gift-btn {
                width: 36px;
                height: 36px;
            }
            
            .profile-avatar {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .profile-name {
                font-size: 16px;
            }
            
            .profile-info-item {
                font-size: 13px;
            }
            
            .tab {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .gift-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .gift-option {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .gifts-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Фиксируем верхнюю часть при открытии клавиатуры */
        .chat-header,
        .online-count,
        .search-container,
        .admin-controls {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Дополнительные стили для мобильной клавиатуры */
        @media (max-height: 500px) {
            .messages-wrapper {
                padding-bottom: 20px;
            }
            
            .input-area {
                padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
            }
        }

        /* Поддержка safe-area для современных браузеров */
        .input-area {
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
        }
        
        /* Стили для улучшения отображения при открытии клавиатуры */
        .keyboard-open .messages-wrapper {
            padding-bottom: 50px;
        }
        
        .keyboard-open .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--header-bg);
            border-top: 1px solid var(--border-color);
        }
        /* Вот такие красивые кнопочки для смайликов */
.reactions {
    display: flex;
    gap: 5px;
    margin-top: 5px;
    flex-wrap: wrap;
}

.reaction {
    background: rgba(255, 255, 255, 0.2);
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 3px;
    cursor: pointer;
    transition: background 0.2s;
}

.reaction:hover {
    background: rgba(255, 255, 255, 0.3);
}

.reaction.active {
    background: rgba(74, 144, 226, 0.5);
}

.light-theme .reaction {
    background: rgba(0, 0, 0, 0.1);
}

.light-theme .reaction:hover {
    background: rgba(0, 0, 0, 0.15);
}
    .scroll-to-bottom-btn {
        position: absolute;
        bottom: 70px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(to right, #4facfe, #00f2fe);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        z-index: 50;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        animation: pulse 2s infinite;
    }
    /* Стили для меню тем */
.theme-menu-toggle {
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
    border-radius: 50%;
    transition: background 0.2s;
    margin-left: 10px;
}

.theme-menu-toggle:hover {
    background: rgba(0, 0, 0, 0.05);
}

.theme-options {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.theme-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 10px;
    border-radius: 10px;
    transition: transform 0.2s;
    border: 2px solid transparent;
}

.theme-option:hover {
    transform: scale(1.05);
    border-color: var(--action-btn-color);
}

.theme-preview {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    margin-bottom: 8px;
    border: 2px solid var(--border-color);
}

/* Предпросмотры для тем */
.default-theme { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); }
.light-theme-preview { background: linear-gradient(135deg, #f5f7fa, #e4e7eb, #f1f3f6); }
.sea-theme-preview { background: linear-gradient(135deg, #0a192f, #112240, #0a192f); }
.halloween-theme-preview { background: linear-gradient(135deg, #1a1a1a, #2d1b00, #1a1a1a); }
.christmas-theme-preview { background: linear-gradient(135deg, #0d200c, #1a3c29, #0d200c); }
   /* Стили для статусов */
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-indicator.online {
    background: #4CAF50;
}

.status-indicator.away {
    background: #FF9800;
}

.status-indicator.busy {
    background: #F44336;
}

.status-indicator.dnd {
    background: #9E9E9E;
}

.status-menu {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.status-option {
    display: flex;
    align-items: center;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
}

.status-option:hover {
    background: rgba(0, 0, 0, 0.1);
}

/* СТИЛИ ДЛЯ ВКЛАДОК ЧАТА */
.chat-tabs {
    display: flex;
    background: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 0 10px;
}

.chat-tab {
    padding: 12px 20px;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    position: relative;
    display: flex;
    align-items: center;
}
.unread-badge {
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    margin-left: 5px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.chat-tab:hover {
    opacity: 0.9;
    background: rgba(255, 255, 255, 0.1);
}

.chat-tab.active {
    opacity: 1;
    border-bottom: 3px solid #4facfe;
    background: rgba(79, 172, 254, 0.1);
    font-weight: bold;
}

/* Для мобильных */
@media (max-width: 768px) {
    .chat-tab {
        padding: 8px 12px;
        font-size: 14px;
    }
}
.private-chat-time {
    font-size: 11px;
    opacity: 0.6;
    margin-top: 3px;
}
/* Стили для меню настроек */
.settings-category {
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
}

.settings-category:last-child {
    border-bottom: none;
}

.settings-category h4 {
    margin-bottom: 10px;
    color: #a0d2eb;
    display: flex;
    align-items: center;
    gap: 8px;
}

.light-theme .settings-category h4 {
    color: #2b6cb0;
}

.settings-btn {
    width: 100%;
    padding: 12px;
    margin-bottom: 8px;
    text-align: left;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
}

.settings-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
}

.settings-btn i {
    width: 20px;
    text-align: center;
}
.poll-input, .poll-option-input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background: var(--input-bg);
    color: var(--input-color);
}

.poll-create-container {
    margin: 15px 0;
}
/* Стили для блока перевода */
.message-translation {
    margin-top: 10px;
    padding: 8px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    border-left: 3px solid #4facfe;
}

.light-theme .message-translation {
    background: rgba(0, 0, 0, 0.05);
}

.translation-header {
    font-size: 11px;
    font-weight: bold;
    color: #4facfe;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.translation-text {
    font-size: 13px;
    line-height: 1.4;
}
/* Умные ответы */
.smart-replies-container {
    display: flex;
    gap: 5px;
    padding: 8px;
    background: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    justify-content: center;
}

.smart-reply-btn {
    background: var(--action-btn-bg);
    color: var(--action-btn-color);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 6px 10px;
    font-size: 11px;
    cursor: pointer;
}
/* УЛУЧШЕННЫЕ АНИМАЦИИ ДЛЯ QUANTUM MESSENGER */

/* Анимация появления сообщения с эффектом параллакса */
@keyframes messageAppearEnhanced {
    0% {
        opacity: 0;
        transform: translateY(20px) scale(0.95) rotateX(5deg);
        filter: blur(5px);
    }
    50% {
        transform: translateY(-5px) scale(1.02);
        filter: blur(2px);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1) rotateX(0);
        filter: blur(0);
    }
}
/* Анимация для ваших сообщений */
.my-message {
    animation: messageAppearEnhanced 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    transform-origin: right center;
}

/* Анимация для сообщений других пользователей */
.other-message {
    animation: messageAppearEnhanced 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    transform-origin: left center;
}

/* Анимация для системных сообщений */
.system-message {
    animation: systemPulse 2s ease-in-out;
}

@keyframes systemPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.9; }
}

/* Плавное появление элементов интерфейса */
.auth-container, .chat-header, .input-area {
    animation: fadeInUp 0.8s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Анимация для кнопок */
.action-btn, .modal-btn, .profile-action-btn {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.action-btn:before, .modal-btn:before, .profile-action-btn:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.action-btn:hover:before, .modal-btn:hover:before, .profile-action-btn:hover:before {
    left: 100%;
}

.action-btn:hover, .modal-btn:hover, .profile-action-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Анимация для аватаров */
.user-avatar, .profile-avatar, .avatar-option {
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.user-avatar:hover, .profile-avatar:hover, .avatar-option:hover {
    transform: scale(1.1) rotate(5deg);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

/* Анимация для поля ввода */
.input-area input {
    transition: all 0.3s ease;
}

.input-area input:focus {
    transform: scale(1.02);
    box-shadow: 0 5px 20px rgba(79, 172, 254, 0.3);
}

/* Анимация для подарков */
.gift-message {
    animation: giftFloat 3s ease-in-out infinite;
}

@keyframes giftFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    33% { transform: translateY(-5px) rotate(2deg); }
    66% { transform: translateY(5px) rotate(-2deg); }
}

.gift-option:hover {
    animation: giftHover 0.6s ease-in-out;
}

@keyframes giftHover {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1.1); }
}

/* Анимация для уведомлений */
.notification {
    animation: notificationSlide 0.5s ease-out, notificationFade 3s 0.5s forwards;
}

@keyframes notificationSlide {
    from {
        transform: translate(-50%, -100px);
        opacity: 0;
    }
    to {
        transform: translate(-50%, 0);
        opacity: 1;
    }
}

/* Анимация для модальных окон */
.modal.active .modal-content {
    animation: modalAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Анимация для вкладок */
.tab, .chat-tab {
    transition: all 0.3s ease;
    position: relative;
}

.tab:after, .chat-tab:after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    width: 0;
    height: 3px;
    background: linear-gradient(to right, #4facfe, #00f2fe);
    transition: all 0.3s ease;
    transform: translateX(-50%);
}

.tab:hover:after, .chat-tab:hover:after {
    width: 80%;
}

.tab.active:after, .chat-tab.active:after {
    width: 100%;
}

/* Анимация для загрузки */
.loading-dot {
    animation: loadingBounce 1.4s infinite ease-in-out both;
}

@keyframes loadingBounce {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1.2);
        opacity: 1;
    }
}

/* Анимация для эмодзи */
.emoji-btn {
    transition: all 0.3s ease;
}

.emoji-btn:hover {
    transform: scale(1.3) rotate(10deg);
    background: rgba(255, 255, 255, 0.2);
}

/* Анимация для реакций */
.reaction {
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.reaction:hover {
    transform: scale(1.2) translateY(-2px);
}

.reaction.active {
    animation: reactionPop 0.4s ease;
}

@keyframes reactionPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.4); }
    100% { transform: scale(1.2); }
}

/* Анимация для скролла к низу */
.scroll-to-bottom-btn {
    animation: bounceIn 0.6s ease, float 2s ease-in-out infinite;
}

@keyframes bounceIn {
    0% { opacity: 0; transform: translate(-50%, 20px) scale(0.8); }
    70% { transform: translate(-50%, -10px) scale(1.1); }
    100% { opacity: 1; transform: translate(-50%, 0) scale(1); }
}

@keyframes float {
    0%, 100% { transform: translate(-50%, 0); }
    50% { transform: translate(-50%, -5px); }
}

/* Анимация для статуса онлайн */
.user-status {
    animation: statusPulse 2s infinite;
}

@keyframes statusPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
}

/* Анимация для поиска */
.search-container {
    animation: slideDown 0.4s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
        height: 0;
    }
    to {
        opacity: 1;
        transform: translateY(0);
        height: auto;
    }
}

/* Анимация для пульсации при записи голоса */
@keyframes recordingPulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 100, 100, 0.7);
    }
    50% {
        transform: scale(1.1);
        box-shadow: 0 0 0 15px rgba(255, 100, 100, 0);
    }
}

.voice-recorder.recording {
    animation: recordingPulse 1.5s infinite;
}

/* Анимация для смены темы */
body {
    transition: background 0.8s ease, color 0.8s ease;
}

/* Анимация для появления смайликов */
.emoji-panel-container.active {
    animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Анимация для умных ответов */
.smart-reply-btn {
    transition: all 0.3s ease;
    animation: fadeInScale 0.5s ease-out;
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.smart-reply-btn:hover {
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* Анимация для перевода сообщений */
.message-translation {
    animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Анимация для уровней и прогресса */
.xp-progress {
    transition: width 1s ease-in-out;
}

.level-up-notification {
    animation: levelUpCelebration 0.8s ease-out;
}

@keyframes levelUpCelebration {
    0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0) rotate(-180deg);
    }
    50% {
        transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
    }
    100% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0);
    }
}

/* Анимация для конфеetti */
@keyframes confettiFall {
    0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
    }
}

/* Адаптивные анимации для мобильных */
@media (max-width: 768px) {
    .my-message, .other-message {
        animation-duration: 0.4s;
    }
    
    .action-btn:hover, .modal-btn:hover, .profile-action-btn:hover {
        transform: none;
    }
}
/* Стили для улучшенного выбора аватарки */
.avatar-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 15px;
}

.avatar-tab {
    padding: 10px 15px;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.3s ease;
    border-bottom: 2px solid transparent;
}

.avatar-tab:hover {
    opacity: 0.9;
}

.avatar-tab.active {
    opacity: 1;
    border-bottom: 2px solid #4facfe;
    background: rgba(79, 172, 254, 0.1);
}

.avatar-tab-content {
    display: none;
    min-height: 200px;
}

.avatar-tab-content.active {
    display: block;
}

.avatar-options-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.avatar-option {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    background: rgba(255, 255, 255, 0.1);
}

.avatar-option:hover {
    transform: scale(1.1);
    border-color: #4facfe;
}

.avatar-option.selected {
    border-color: #4facfe;
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
}

.avatar-upload-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin: 15px 0;
}

.avatar-upload-area {
    width: 200px;
    height: 200px;
    border: 2px dashed var(--border-color);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    padding: 20px;
}

.avatar-upload-area:hover {
    border-color: #4facfe;
    background: rgba(79, 172, 254, 0.1);
}

.avatar-upload-area i {
    font-size: 48px;
    margin-bottom: 10px;
    color: #4facfe;
}

.avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--border-color);
    display: none;
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.color-options-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.color-option:hover {
    transform: scale(1.1);
    border-color: white;
}

.color-option.selected {
    border-color: white;
    transform: scale(1.1);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

.selected-color-preview {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-top: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.color-preview {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid var(--border-color);
}

/* Анимации для улучшенного интерфейса */
@keyframes avatarPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.user-avatar:hover {
    animation: avatarPulse 1s infinite;
}

/* Адаптивность для мобильных */
@media (max-width: 768px) {
    .avatar-options-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .avatar-option {
        width: 40px;
        height: 40px;
        font-size: 20px;
    }
    
    .avatar-upload-area {
        width: 150px;
        height: 150px;
    }
    
    .color-options-grid {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .avatar-tab {
        padding: 8px 12px;
        font-size: 14px;
    }
}
    </style>
</head>
<!-- Модальное окно для создания опроса -->
<div class="modal" id="pollModal">
    <div class="modal-content">
        <h3>Создать опрос</h3>
        <div class="poll-create-container">
            <input type="text" id="pollQuestion" placeholder="Введите ваш вопрос..." class="poll-input">
            <div id="pollOptions">
                <input type="text" placeholder="Вариант 1" class="poll-option-input">
                <input type="text" placeholder="Вариант 2" class="poll-option-input">
            </div>
            <button class="action-btn" id="addPollOptionBtn" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i> Добавить вариант
            </button>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closePollBtn">Отмена</button>
            <button class="modal-btn primary" id="createPollBtn">Создать</button>
        </div>
    </div>
</div>
<!-- Модальное окно настроек -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <h3>⚙️ Настройки Quantum Messenger</h3>
        
        <div class="settings-category">
            <h4>👤 Профиль</h4>
            <button class="settings-btn" onclick="document.getElementById('avatarModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-user-circle"></i> Сменить аватар
            </button>
            <button class="settings-btn" onclick="showStatusMenu(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-circle"></i> Изменить статус
            </button>
            <button class="settings-btn" onclick="showLevelInfo(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-chart-line"></i> Моя статистика
            </button>
        </div>
        
        <div class="settings-category">
            <h4>🎨 Внешний вид</h4>
            <button class="settings-btn" onclick="document.getElementById('themeModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-palette"></i> Сменить тему
            </button>
        </div>
        
        <div class="settings-category">
            <h4>🎮 Развлечения</h4>
            <button class="settings-btn" onclick="document.getElementById('giftModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-gift"></i> Отправить подарок
            </button>
            <button class="settings-btn" onclick="claimDailyReward(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-calendar-day"></i> Ежедневная награда
            </button>
            <button class="settings-btn" onclick="flipCoin(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-coins"></i> Бросить монетку
            </button>
            <button class="settings-btn" onclick="createPollModal(); document.getElementById('settingsModal').classList.remove('active');">
    <i class="fas fa-chart-bar"></i> Создать опрос
</button>
        </div>
        
        <div class="settings-category">
            <h4>⚡ Система</h4>
            <button class="settings-btn" onclick="clearChat(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-broom"></i> Очистить чат
            </button>
            <button class="settings-btn" onclick="document.getElementById('settingsModal').classList.remove('active'); showNotification('Уведомления включены!');">
                <i class="fas fa-bell"></i> Уведомления
            </button>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closeSettingsBtn">Закрыть</button>
        </div>
    </div>
</div>
<body>
    <div class="app-container">
        <div class="header">
            <div>
                <button class="theme-toggle" id="themeToggle">🌙</button>
            </div>
            <button class="theme-menu-toggle" id="themeMenuToggle">
    <i class="fas fa-palette"></i>
</button>
            <div style="display: flex; align-items: center;">
                <div class="logo">⚛</div>
                <div>Quantum Messenger</div>
            </div>
            <div></div>
        </div>
        
        <div class="main-container">
            <div class="auth-container" id="authContainer">
                <div class="auth-title">Войдите в систему с вашим именем</div>
                <input type="text" id="nameInput" placeholder="Введите ваше имя">
                
                <div class="secret-code-container">
                    <div>Секретный код для разработчиков:</div>
                    <input type="password" id="codeInput" placeholder="Введите секретный код">
                    <div>Если у вас есть код разработчика, введите его для получения специальных прав</div>
                </div>
                
                <button id="enterBtn">Войти в чат</button>
                <div>Ваше имя будет сохранено для будущих посещений</div>
            </div>
            
            <div class="chat-wrapper" id="chatWrapper" style="display: none;">
                <div class="chat-header">
                    <div class="user-name">
                        <div class="user-avatar" id="userAvatar">
                            <img src="" id="avatarImg" style="display: none;">
                            <span id="avatarInitial">U</span>
                            <div class="scroll-to-bottom-btn" id="scrollToBottomBtn" style="display: none;">
                                <style>
    .scroll-to-bottom-btn {
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: linear-gradient(to right, #4facfe, #00f2fe);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        cursor: pointer;
        z-index: 50;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-5px);}
        60% {transform: translateY(-3px);}
    }
</style>
    <i class="fas fa-arrow-down"></i> Новое сообщение
</div>
                        </div>
                        <span id="userName"></span>
                        <span class="verified-badge" id="verifiedBadge" style="display: none;">✓</span>
                        <span class="developer-badge" id="developerBadge" style="display: none;">Разработчик</span>
                        <span class="tester-badge" id="testerBadge" style="display: none;">Тестер</span>
                    </div>
                    <div class="user-controls">
    <div class="action-btn" id="searchToggleBtn">
        <i class="fas fa-search"></i> <span>Поиск</span>
    </div>
      <div class="action-btn" id="settingsBtn">
        <i class="fas fa-cog"></i> <span>Настройки</span>
    </div>
    
    <div class="action-btn" id="statusBtn" onclick="showStatusMenu()">
    <i class="fas fa-circle"></i> <span>Статус</span>
</div>
    <div class="action-btn" id="avatarBtn">
        <i class="fas fa-user-circle"></i> <span>Аватар</span>
    </div>
    <div class="action-btn logout-btn" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> <span>Выйти</span>
    </div>
</div>
                </div>
                <!-- НАЧАЛО КОДА ДЛЯ ВКЛАДОК -->
<div class="chat-tabs">
    <div class="chat-tab active" data-tab="general">
        Общий чат
    </div>
    <div class="chat-tab" data-tab="private" id="privateChatTab">
        Приватные чаты
        <span class="unread-badge" id="unreadPrivateBadge" style="display: none;">0</span>
    </div>
</div>
<!-- КОНЕЦ КОДА ДЛЯ ВКЛАДОК -->
                <div class="online-count">
                    <span id="onlineCount">0</span> пользователей онлайн
                </div>
                <div class="chat-mode-indicator" id="chatModeIndicator" style="display: none;">
    <i class="fas fa-lock"></i> Приватный чат с: <span id="privateChatWith"></span>
    <button class="action-btn" id="exitPrivateChatBtn" style="margin-left: 10px;">
        <i class="fas fa-times"></i> Выйти
    </button>
</div>
                
                <div class="search-container" id="searchContainer" style="display: none;">
                    <input type="text" id="searchInput" placeholder="Поиск по сообщениям...">
                    <button id="searchBtn">Найти</button>
                    <button id="closeSearchBtn">X</button>
                </div>
                
                <div class="admin-controls" id="adminControls" style="display: none;">
                    <div>Панель разработчика</div>
                    <div class="action-btn clear-chat-btn" id="clearChatBtn">Очистить чат</div>
                </div>
                
                <div class="messages-wrapper" id="messagesContainer">
                    <div class="empty-chat">
                        <i class="fas fa-comments"></i>
                        <p>Чат пуст. Будьте первым, кто отправит сообщение!</p>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typingIndicator"></div>
                
                <div class="input-area">
                    
                    <button class="emoji-toggle" id="emojiToggleBtn">
                        <i class="far fa-smile"></i>
                    </button>
                    <button class="voice-recorder" id="voiceRecordBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="gift-btn" id="giftBtn">
                        <i class="fas fa-gift"></i>
                    </button>
                    
                    <input type="text" id="messageInput" placeholder="Введите ваше сообщение..." autocomplete="off">
                    <button id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i> <span>Отправить</span>
                    </button>
                </div>
                <div class="smart-replies-container" id="smartRepliesContainer"></div>

                <div class="emoji-panel-container" id="emojiPanel">
                    <div class="emoji-category">
                        <div class="emoji-category-title">Популярные</div>
                        <div class="emoji-panel">
                            <button class="emoji-btn">😀</button>
                            <button class="emoji-btn">😂</button>
                            <button class="emoji-btn">😍</button>
                            <button class="emoji-btn">🥰</button>
                            <button class="emoji-btn">😎</button>
                            <button class="emoji-btn">🤔</button>
                            <button class="emoji-btn">😴</button>
                            <button class="emoji-btn">😭</button>
                            <button class="emoji-btn">😡</button>
                            <button class="emoji-btn">👍</button>
                            <button class="emoji-btn">👎</button>
                            <button class="emoji-btn">❤️</button>
                            <button class="emoji-btn">🔥</button>
                            <button class="emoji-btn">🎉</button>
                            <button class="emoji-btn">🤩</button>
                            <button class="emoji-btn">🙏</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <h3>Выберите аватар</h3>
            <div class="avatar-options" id="avatarOptions"></div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeAvatarBtn">Отмена</button>
                <button class="modal-btn primary" id="saveAvatarBtn">Сохранить</button>
            </div>
        </div>
    </div>
    <!-- Модальное окно для создания опроса -->
<div class="modal" id="pollModal">
    <div class="modal-content">
        <h3>Создать опрос</h3>
        <div class="poll-create-container">
            <input type="text" id="pollQuestion" placeholder="Введите ваш вопрос..." class="poll-input">
            <div id="pollOptions">
                <input type="text" placeholder="Вариант 1" class="poll-option-input">
                <input type="text" placeholder="Вариант 2" class="poll-option-input">
            </div>
            <button class="action-btn" id="addPollOptionBtn" style="margin-bottom: 15px;">
                <i class="fas fa-plus"></i> Добавить вариант
            </button>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closePollBtn">Отмена</button>
            <button class="modal-btn primary" id="createPollBtn">Создать</button>
        </div>
    </div>
</div>
<!-- Конец модального окна опроса -->

    <div class="modal" id="giftModal">
        <div class="modal-content">
            <h3>Отправить подарок</h3>
            <div class="gift-recipient" id="giftRecipient">
                <div>Выберите получателя:</div>
                <select class="recipient-select" id="recipientSelect">
                    <option value="">Загрузка пользователей...</option>
                </select>
            </div>
            <div class="gift-category">
                <h4>Обычные подарки</h4>
                <div class="gift-options">
                    <div class="gift-option" data-gift="🎁" data-type="regular">🎁</div>
                    <div class="gift-option" data-gift="🎉" data-type="regular">🎉</div>
                    <div class="gift-option" data-gift="❤️" data-type="regular">❤️</div>
                    <div class="gift-option" data-gift="👍" data-type="regular">👍</div>
                    <div class="gift-option" data-gift="✨" data-type="regular">✨</div>
                    <div class="gift-option" data-gift="🎈" data-type="regular">🎈</div>
                </div>
            </div>
            <div class="gift-category">
                <h4>NFT подарки <span class="gift-counter" id="nftCounter"></span></h4>
                <div class="gift-options">
                    <div class="gift-option nft" data-gift="🏆" data-type="nft">🏆</div>
                    <div class="gift-option nft" data-gift="⭐" data-type="nft">⭐</div>
                    <div class="gift-option nft" data-gift="👑" data-type="nft">👑</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeGiftBtn">Отмена</button>
            </div>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="profile-modal-content">
                <div class="profile-avatar" id="profileAvatar">
                    <img src="" id="profileAvatarImg" style="display: none;">
                    <span id="profileAvatarInitial">U</span>
                </div>
                <div class="profile-name" id="profileName"></div>
                <div class="profile-badges" id="profileBadges"></div>
                
                <div class="tab-container">
                    <div class="tab active" data-tab="info">Информация</div>
                    <div class="tab" data-tab="stats">Статистика</div>
                    
<div class="tab" data-tab="favorites">Избранное</div>

<div class="tab-content" id="tab-favorites">
    <div class="profile-section">
        <div class="profile-section-title">
            <i class="fas fa-star"></i> Сохраненные сообщения
        </div>
        <div class="favorites-list" id="favoritesList">
            <div class="loading">
                <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            </div>
        </div>
    </div>
</div>
                    <div class="tab" data-tab="gifts">Подарки</div>
                    <div class="tab" data-tab="media">Медиа</div>
                    <div class="tab" data-tab="achievements">Достижения</div>
                </div>
                
                <div class="tab-content active" id="tab-info">
                    <div class="profile-info">
                        <div class="profile-info-item">
                            <span class="profile-info-label">Статус:</span>
                            <span class="profile-info-value" id="profileStatus">Онлайн</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Сообщений:</span>
                            <span class="profile-info-value" id="profileMessageCount">0</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Зарегистрирован:</span>
                            <span class="profile-info-value" id="profileRegistered">Сегодня</span>
                        </div>
                        <div class="profile-info-item">
                            <span class="profile-info-label">Последняя активность:</span>
                            <span class="profile-info-value" id="profileLastOnline">Сейчас</span>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <div class="profile-section-title">
                            <i class="fas fa-sticky-note"></i> Ваша заметка
                        </div>
                        <textarea class="user-note" id="userNote" placeholder="Добавьте заметку об этом пользователе..."></textarea>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-stats">
                    <div class="profile-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="statDays">0</div>
                            <div class="stat-label">Дней в чате</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAvg">0</div>
                            <div class="stat-label">Сообщений в день</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statReactions">0</div>
                            <div class="stat-label">Реакций</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statVoice">0</div>
                            <div class="stat-label">Голосовых</div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <div class="profile-section-title">
                            <i class="fas fa-chart-line"></i> Активность за неделю
                        </div>
                        <div class="activity-chart" id="activityChart">
                            <div class="chart-bar" style="height: 30%"></div>
                            <div class="chart-bar" style="height: 60%"></div>
                            <div class="chart-bar" style="height: 40%"></div>
                            <div class="chart-bar" style="height: 80%"></div>
                            <div class="chart-bar" style="height: 50%"></div>
                            <div class="chart-bar" style="height: 20%"></div>
                            <div class="chart-bar" style="height: 70%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-gifts">
                    <div class="profile-section">
                        <div class="profile-section-title">
                            <i class="fas fa-gift"></i> Полученные подарки
                        </div>
                        <div class="gifts-list" id="giftsList">
                            <div class="loading">
                                <div class="loading-dots">
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                    <div class="loading-dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-media">
                    <div class="profile-section">
                        <div class="profile-section-title">
                            <i class="fas fa-images"></i> Медиафайлы
                        </div>
                        <div class="media-grid" id="mediaGrid">
                            <div class="media-item">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="media-item">
                                <i class="fas fa-image"></i>
                            </div>
                            <div class="media-item">
                                <i class="fas fa-image"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-achievements">
                    <div class="profile-section">
                        <div class="profile-section-title">
                            <i class="fas fa-trophy"></i> Достижения
                        </div>
                        <div class="achievement-list" id="achievementList">
                            <div class="achievement-item">
                                <div class="achievement-icon">🏆</div>
                                <div class="achievement-info">
                                    <div class="achievement-title">Первый шаг</div>
                                    <div class="achievement-desc">Отправить первое сообщение</div>
                                </div>
                            </div>
                            <div class="achievement-item">
                                <div class="achievement-icon">💬</div>
                                <div class="achievement-info">
                                    <div class="achievement-title">Общительный</div>
                                    <div class="achievement-desc">Отправить 100 сообщений</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions" id="profileActions">
                    <button class="profile-action-btn primary" id="giveGiftBtn">
                        <i class="fas fa-gift"></i> Подарить
                    </button>
                    <button class="profile-action-btn secondary" id="closeProfileBtn">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>
    <audio id="giftSound" src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDbraqwE-buTjLjvHOCbSSEM39AoSwQnjE",
            authDomain: "quantu-57490.firebaseapp.com",
            databaseURL: "https://quantu-57490-default-rtdb.firebaseio.com",
            projectId: "quantu-57490",
            storageBucket: "quantu-57490.firebasestorage.app",
            messagingSenderId: "651950401509",
            appId: "1:651950401509:web:c58bc0d09783a6e4ce710c"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Получение элементов DOM
        const authContainer = document.getElementById('authContainer');
        const chatWrapper = document.getElementById('chatWrapper');
        
        const nameInput = document.getElementById('nameInput');
        const codeInput = document.getElementById('codeInput');
        const enterBtn = document.getElementById('enterBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const avatarImg = document.getElementById('avatarImg');
        const avatarInitial = document.getElementById('avatarInitial');
        const verifiedBadge = document.getElementById('verifiedBadge');
        const developerBadge = document.getElementById('developerBadge');
        const testerBadge = document.getElementById('testerBadge');
        const logoutBtn = document.getElementById('logoutBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const adminControls = document.getElementById('adminControls');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const onlineCount = document.getElementById('onlineCount');
        const themeToggle = document.getElementById('themeToggle');
        const exitPrivateChatBtn = document.getElementById('exitPrivateChatBtn');
        const voiceRecordBtn = document.getElementById('voiceRecordBtn');
        const giftBtn = document.getElementById('giftBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const searchContainer = document.getElementById('searchContainer');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const closeSearchBtn = document.getElementById('closeSearchBtn');
        const searchToggleBtn = document.getElementById('searchToggleBtn');
        const avatarBtn = document.getElementById('avatarBtn');
        const avatarModal = document.getElementById('avatarModal');
        const avatarOptions = document.getElementById('avatarOptions');
        const closeAvatarBtn = document.getElementById('closeAvatarBtn');
        const saveAvatarBtn = document.getElementById('saveAvatarBtn');
        const giftModal = document.getElementById('giftModal');
        const closeGiftBtn = document.getElementById('closeGiftBtn');
        const nftCounter = document.getElementById('nftCounter');
        const notificationSound = document.getElementById('notificationSound');
        const giftSound = document.getElementById('giftSound');
        const profileModal = document.getElementById('profileModal');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileAvatarImg = document.getElementById('profileAvatarImg');
        const profileAvatarInitial = document.getElementById('profileAvatarInitial');
        const profileName = document.getElementById('profileName');
        const profileStatus = document.getElementById('profileStatus');
        const profileMessageCount = document.getElementById('profileMessageCount');
        const profileRegistered = document.getElementById('profileRegistered');
        const profileLastOnline = document.getElementById('profileLastOnline');
        const profileBadges = document.getElementById('profileBadges');
        const profileActions = document.getElementById('profileActions');
        const closeProfileBtn = document.getElementById('closeProfileBtn');
        const userNote = document.getElementById('userNote');
        const statDays = document.getElementById('statDays');
        const statAvg = document.getElementById('statAvg');
        const statReactions = document.getElementById('statReactions');
        const statVoice = document.getElementById('statVoice');
        const activityChart = document.getElementById('activityChart');
        const mediaGrid = document.getElementById('mediaGrid');
        const achievementList = document.getElementById('achievementList');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const recipientSelect = document.getElementById('recipientSelect');
        const giftsList = document.getElementById('giftsList');
        const giveGiftBtn = document.getElementById('giveGiftBtn');
        const emojiToggleBtn = document.getElementById('emojiToggleBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiButtons = document.querySelectorAll('.emoji-btn');
        
        // Переменные состояния
        let currentUser = '';
        let userId = '';
        let isDeveloper = false;
        let isTester = false;
        let userColor = '';
        let userAvatarUrl = '';
        let isTyping = false;
        let typingTimeout = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let quotedMessage = null;
        let searchActive = false;
        let searchTerm = '';
        let messagesListener = null;
        let onlineUsersListener = null;
        let typingListener = null;
        let messageDeleteListener = null;
        let messageEditListener = null;
        let profilesListener = null;
        let currentProfileView = null;
        // Добавляем эти переменные к остальным
let isPrivateChatActive = false;
let unreadPrivateCount = 0;
let privateMessagesListeners = {};
let privateChatWithUserId = null;
let privateChatWithUserName = '';
        let profileNotes = {};
        let nftAvailable = 3; // Количество доступных NFT подарков
        const secretCode = "кутактус";
        const testerCode = "кактуску";
        const encryptionKey = "quantum-secret-key-2023";
        let currentGiftRecipient = null;
        let isFirstLoad = true;
        let keyboardOpen = false;
        
        // Предопределенные аватары
        const defaultAvatars = [
            '😀', '😎', '🤖', '🐱', '🐶', '🦊', '🐻', '🐼',
            '🌻', '🌵', '🍕', '🚀', '⭐', '🌈', '🎮', '🎸'
        ];
        
        // Популярные эмодзи для быстрого доступа
        const popularEmojis = [
            '😀', '😂', '😍', '🥰', '😎', '🤔', '😴', '😭',
            '😡', '👍', '👎', '❤️', '🔥', '🎉', '🤩', '🙏'
        ];
        
        // Достижения
        const achievements = [
            { id: 'first_message', icon: '🏆', title: 'Первый шаг', description: 'Отправить первое сообщение' },
            { id: 'chatty', icon: '💬', title: 'Общительный', description: 'Отправить 100 сообщений' },
            { id: 'popular', icon: '👍', title: 'Популярный', description: 'Получить 10 реакций на сообщения' },
            { id: 'early_bird', icon: '🌅', title: 'Ранняя пташка', description: 'Быть активным в течение 7 дней подряд' },
            { id: 'developer', icon: '👨‍💻', title: 'Разработчик', description: 'Получить статус разработчика' },
            { id: 'voice', icon: '🎤', title: 'Голос чата', description: 'Отправить 5 голосовых сообщений' },
            { id: 'gift_master', icon: '🎁', title: 'Щедрый', description: 'Отправить 10 подарков' },
            { id: 'nft_collector', icon: '🏆', title: 'NFT Коллекционер', description: 'Отправить NFT подарок' }
        ];
        
        // Инициализация при загрузке страницы
        window.addEventListener('load', () => {
            // Проверяем сохраненные данные пользователя
            const savedName = localStorage.getItem('quantumUsername');
            const savedUserId = localStorage.getItem('quantumUserId');
            const savedDeveloper = localStorage.getItem('quantumDeveloper');
            const savedTester = localStorage.getItem('quantumTester');
            const savedAvatar = localStorage.getItem('quantumAvatar');
            const savedTheme = localStorage.getItem('quantumTheme');
            const savedNotes = localStorage.getItem('quantumUserNotes');
            const savedNftCount = localStorage.getItem('quantumNftCount');
            
            // Загружаем заметки о пользователях
            if (savedNotes) {
                try {
                    profileNotes = JSON.parse(savedNotes);
                } catch (e) {
                    console.error("Ошибка загрузки заметок:", e);
                    profileNotes = {};
                }
            }
            
            // Загружаем количество NFT
            if (savedNftCount) {
                nftAvailable = parseInt(savedNftCount);
            }
            
            // Применяем сохраненную тему
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                themeToggle.textContent = '☀️';
            }
            
            if (savedName && savedUserId) {
                nameInput.value = savedName;
                userId = savedUserId;
                
                if (savedDeveloper === 'true') {
                    codeInput.value = secretCode;
                } else if (savedTester === 'true') {
                    codeInput.value = testerCode;
                }
                
                if (savedAvatar) {
                    userAvatarUrl = savedAvatar;
                }
                
                // Автоматически входим в чат
                setTimeout(enterChat, 100);
            } else {
                // Генерируем новый ID пользователя
                userId = generateUserId();
                localStorage.setItem('quantumUserId', userId);
            }
            
            // Заполняем варианты аватаров
            renderAvatarOptions();
            
            // Настраиваем вкладки профиля
            setupProfileTabs();
            
            // Обновляем счетчик NFT
            updateNftCounter();
            
            // Фокусируемся на поле ввода имени
            nameInput.focus();
            
            // Инициализируем обработчики событий
            initEventListeners();
            
            // Настройка обработчиков для клавиатуры
            setupKeyboardHandlers();
        });
        
        // Настройка обработчиков для клавиатуры
        function setupKeyboardHandlers() {
            // Обработка виртуальной клавиатуры на мобильных устройствах
            if ('visualViewport' in window) {
                const visualViewport = window.visualViewport;
                
                visualViewport.addEventListener('resize', function() {
                    // Определяем, открыта ли клавиатура
                    if (visualViewport.height < window.innerHeight * 0.7) {
                        keyboardOpen = true;
                        document.body.classList.add('keyboard-open');
                        scrollToBottom();
                    } else {
                        keyboardOpen = false;
                        document.body.classList.remove('keyboard-open');
                    }
                });
            }
            
            // Фокус на поле ввода сообщения
            messageInput.addEventListener('focus', () => {
                setTimeout(() => {
                    scrollToBottom();
                }, 300);
            });
        }
        
        // Настройка вкладок профиля
        function setupProfileTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Убираем активный класс у всех вкладок и контента
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс к выбранной вкладке и контенту
                    tab.classList.add('active');
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    
                    // Если выбрана вкладка с подарками, загружаем подарки
                    if (tabId === 'gifts' && currentProfileView) {
                        loadUserGifts(currentProfileView);
                    }
                    
                    // Если выбрана вкладка с медиа, загружаем медиафайлы
                    if (tabId === 'media' && currentProfileView) {
                        loadUserMedia(currentProfileView);
                    }
                    
                    // Если выбрана вкладка с достижениями, загружаем достижения
                    if (tabId === 'achievements' && currentProfileView) {
                        loadUserAchievements(currentProfileView);
                    }
                });
            });
        }
        
        // Обновление счетчика NFT
        function updateNftCounter() {
            nftCounter.textContent = `(${nftAvailable} доступно)`;
        }
        
        // Инициализация обработчиков событий
        function initEventListeners() {
            enterBtn.addEventListener('click', enterChat);
            // Обработчик для кнопки выхода из приватного чата
exitPrivateChatBtn.addEventListener('click', exitPrivateChat);
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') enterChat();
            });
            
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') enterChat();
            });
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                } else {
                    // Отправляем событие набора текста
                    if (!isTyping) {
                        isTyping = true;
                        database.ref('typing/' + userId).set({
                            name: currentUser,
                            timestamp: Date.now()
                        });
                    }
                    
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        isTyping = false;
                        database.ref('typing/' + userId).remove();
                    }, 1000);
                }
            });
            
            messageInput.addEventListener('input', () => {
                sendBtn.disabled = messageInput.value.trim() === '';
            });
            
            sendBtn.addEventListener('click', sendMessage);
            
            logoutBtn.addEventListener('click', () => {
                if (confirm("Вы уверены, что хотите сменить пользователя?")) {
                    // Удаляем слушатели
                    removeAllListeners();
                    
                    localStorage.removeItem('quantumUsername');
                    localStorage.removeItem('quantumDeveloper');
                    localStorage.removeItem('quantumTester');
                    localStorage.removeItem('quantumAvatar');
                    window.location.reload();
                }
            });
            
            clearChatBtn.addEventListener('click', clearChat);
            
            themeToggle.addEventListener('click', toggleTheme);
            
            voiceRecordBtn.addEventListener('click', toggleRecording);
            
            giftBtn.addEventListener('click', () => {
                loadOnlineUsersForGifts();
                giftModal.classList.add('active');
            });
            
            closeGiftBtn.addEventListener('click', () => {
                giftModal.classList.remove('active');
            });
            
            // Обработчик выбора подарка
            document.querySelectorAll('.gift-option').forEach(option => {
                option.addEventListener('click', () => {
                    const gift = option.getAttribute('data-gift');
                    const type = option.getAttribute('data-type');
                    const recipientId = recipientSelect.value;
                    
                    if (!recipientId) {
                        showNotification("Сначала выберите получателя");
                        return;
                    }
                    
                    const recipientName = recipientSelect.options[recipientSelect.selectedIndex].text;
                    sendGift(gift, type, recipientId, recipientName);
                    giftModal.classList.remove('active');
                });
            });
            
            searchToggleBtn.addEventListener('click', () => {
                searchContainer.style.display = searchContainer.style.display === 'flex' ? 'none' : 'flex';
                if (searchContainer.style.display === 'flex') {
                    searchInput.focus();
                } else {
                    clearSearch();
                }
            });
            
            searchBtn.addEventListener('click', performSearch);
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });
            
            closeSearchBtn.addEventListener('click', clearSearch);
            
            avatarBtn.addEventListener('click', () => {
                avatarModal.classList.add('active');
            });
            
            closeAvatarBtn.addEventListener('click', () => {
                avatarModal.classList.remove('active');
            });
            
            saveAvatarBtn.addEventListener('click', saveAvatar);
            
            closeProfileBtn.addEventListener('click', () => {
                profileModal.classList.remove('active');
                // Сохраняем заметку о пользователе
                if (currentProfileView) {
                    saveUserNote(currentProfileView);
                }
            });
            
            giveGiftBtn.addEventListener('click', () => {
                // Открываем модальное окно подарка с предвыбранным получателем
                loadOnlineUsersForGifts(currentProfileView);
                giftModal.classList.add('active');
            });
            
            // Сохранение заметки при изменении
            userNote.addEventListener('change', () => {
                if (currentProfileView) {
                    saveUserNote(currentProfileView);
                }
            });
            
            // Клик по аватару пользователя открывает профиль
            userAvatar.addEventListener('click', () => {
                showUserProfile(userId);
            });
            
            // Обработчики для эмодзи
            emojiToggleBtn.addEventListener('click', toggleEmojiPanel);
            
            emojiButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const emoji = button.textContent;
                    messageInput.value += emoji;
                    messageInput.focus();
                    emojiPanel.classList.remove('active');
                });
            });
            
            // Закрытие панели эмодзи при клике вне ее
            document.addEventListener('click', (e) => {
                if (emojiPanel.classList.contains('active') && 
                    !emojiPanel.contains(e.target) && 
                    e.target !== emojiToggleBtn) {
                    emojiPanel.classList.remove('active');
                }
            });
        }
        
        // Переключение панели эмодзи
        function toggleEmojiPanel() {
            emojiPanel.classList.toggle('active');
            if (emojiPanel.classList.contains('active')) {
                scrollToBottom();
            }
        }
        
        // Загрузка онлайн-пользователей для выбора получателя подарка
function loadOnlineUsersForGifts(preSelectedUserId = null) {
    recipientSelect.innerHTML = '<option value="">Загрузка пользователей...</option>';

    // Если мы в приватном чате и не указан другой получатель, выбираем собеседника
    if (isPrivateChatActive && privateChatWithUserId && !preSelectedUserId) {
        preSelectedUserId = privateChatWithUserId;
    }

    database.ref('onlineUsers').once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            recipientSelect.innerHTML = '<option value="">Нет активных пользователей</option>';
            return;
        }

        recipientSelect.innerHTML = '<option value="">Выберите получателя</option>';

        const users = snapshot.val();
        Object.keys(users).forEach(userId => {
            if (userId !== currentUser) {
                const user = users[userId];
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = user.name;
                option.selected = (userId === preSelectedUserId);
                recipientSelect.appendChild(option);
            }
        });

        // Если есть предвыбранный пользователь, устанавливаем его
        if (preSelectedUserId) {
            recipientSelect.value = preSelectedUserId;
        }
    });
}
        
        // Сохранение заметки о пользователе
        function saveUserNote(userId) {
            if (!userId) return;
            
            profileNotes[userId] = userNote.value;
            localStorage.setItem('quantumUserNotes', JSON.stringify(profileNotes));
        }
        
        // Загрузка заметки о пользователе
        function loadUserNote(userId) {
            if (!userId) return '';
            
            return profileNotes[userId] || '';
        }
        
        // Удаление всех слушателей
        function removeAllListeners() {
            if (messagesListener) {
                database.ref('messages').off('child_added', messagesListener);
            }
            if (onlineUsersListener) {
                database.ref('onlineUsers').off('value', onlineUsersListener);
            }
            if (typingListener) {
                database.ref('typing').off('child_added', typingListener);
                database.ref('typing').off('child_removed', typingListener);
            }
            if (messageDeleteListener) {
                database.ref('messages').off('child_removed', messageDeleteListener);
            }
            if (messageEditListener) {
                database.ref('messages').off('child_changed', messageEditListener);
            }
            if (profilesListener) {
                database.ref('profiles').off('value', profilesListener);
            }
        }
        
        // Генерация ID пользователя
        function generateUserId() {
            return 'user-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now().toString(36);
        }
        
        // Генерация цвета для пользователя
        function generateUserColor() {
            const colors = ['#4facfe', '#00f2fe', '#a0d2eb', '#7fdbda', '#6a9bd8'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Шифрование сообщения
        function encryptMessage(message) {
            return CryptoJS.AES.encrypt(message, encryptionKey).toString();
        }
        
        // Дешифрование сообщения
        function decryptMessage(ciphertext) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, encryptionKey);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                return decrypted || ciphertext;
            } catch (e) {
                return ciphertext;
            }
        }
        // Показывать/скрывать кнопку прокрутки при необходимости
messagesContainer.addEventListener('scroll', function() {
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    if (!scrollToBottomBtn) return;
    
    // Показываем кнопку, если пользователь прокрутил вверх
    if (messagesContainer.scrollHeight - messagesContainer.scrollTop > messagesContainer.clientHeight + 100) {
        scrollToBottomBtn.style.display = 'flex';
    } else {
        scrollToBottomBtn.style.display = 'none';
    }
});

// Обработчик клика по кнопке прокрутки
document.addEventListener('click', function(e) {
    if (e.target.id === 'scrollToBottomBtn' || e.target.closest('#scrollToBottomBtn')) {
        scrollToBottom();
    }
});
        // Прокрутка к последнему сообщению
        function scrollToBottom() {
            setTimeout(() => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // Вход в чат
        function enterChat() {
            const name = nameInput.value.trim();
            const code = codeInput.value.trim();
            
            if (name) {
                currentUser = name;
                userColor = generateUserColor();
                userName.textContent = name;
                // Запускаем отслеживание приватных сообщений
setupPrivateMessagesListener();
                
                // Устанавливаем аватар
                updateAvatarDisplay();
                
                userAvatar.style.background = userColor;
                
                // Проверка кода разработчика и тестера
                isDeveloper = code === secretCode;
                isTester = code === testerCode;
                
                if (isDeveloper) {
                    verifiedBadge.style.display = 'inline';
                    developerBadge.style.display = 'inline';
                    clearChatBtn.style.display = 'block';
                    adminControls.style.display = 'flex';
                    localStorage.setItem('quantumDeveloper', 'true');
                    localStorage.setItem('quantumTester', 'false');
                } else {
                    isDeveloper = false;
                    verifiedBadge.style.display = 'none';
                    developerBadge.style.display = 'none';
                    clearChatBtn.style.display = 'none';
                    adminControls.style.display = 'none';
                    localStorage.setItem('quantumDeveloper', 'false');
                }
                
                if (isTester) {
                    testerBadge.style.display = 'inline';
                    localStorage.setItem('quantumTester', 'true');
                } else {
                    isTester = false;
                    testerBadge.style.display = 'none';
                    localStorage.setItem('quantumTester', 'false');
                }
                
                // Сохраняем имя пользователя
                localStorage.setItem('quantumUsername', name);
                
                // Переключаем видимость контейнеров
                authContainer.style.display = 'none';
                chatWrapper.style.display = 'flex';
                
                // Фокусируемся на поле ввода сообщения
                setTimeout(() => {
                    messageInput.focus();
                }, 100);
                
                // Загружаем сообщения и настраиваем онлайн-пользователей
                loadMessages();
                setupOnlineUsers();
                setupTypingIndicator();
                setupProfiles();
                
                // Показываем уведомление о входе
                showNotification(`Добро пожаловать, ${name}!`);
            } else {
                alert("Пожалуйста, введите ваше имя");
                nameInput.focus();
            }
        }
        
        // Обновление отображения аватара
        function updateAvatarDisplay() {
            if (userAvatarUrl) {
                if (userAvatarUrl.startsWith('http') || userAvatarUrl.startsWith('data:')) {
                    avatarImg.src = userAvatarUrl;
                    avatarImg.style.display = 'block';
                    avatarInitial.style.display = 'none';
                } else {
                    avatarInitial.textContent = userAvatarUrl;
                    avatarImg.style.display = 'none';
                    avatarInitial.style.display = 'block';
                }
            } else {
                avatarInitial.textContent = currentUser.charAt(0).toUpperCase();
                avatarImg.style.display = 'none';
                avatarInitial.style.display = 'block';
            }
        }
        
        // Отправка сообщения - ИСПРАВЛЕННАЯ ВЕРСИЯ
        // Умные ответы
const smartReplies = {
    "привет": ["Привет", "Как дела", "Что нового"],
    "как дела": ["Норм", "Отлично", "Как сам"],
    "спасибо": ["Не за что", "Обращайся", "👍"]
};

function showSmartReplies(text) {
    const container = document.getElementById('smartRepliesContainer');
    if (!container) return;
    
    container.innerHTML = '';
    const cleanText = text.toLowerCase();
    
    for (const [key, replies] of Object.entries(smartReplies)) {
        if (cleanText.includes(key)) {
            replies.forEach(reply => {
                const btn = document.createElement('button');
                btn.className = 'smart-reply-btn';
                btn.textContent = reply;
                btn.onclick = () => {
                    messageInput.value = reply;
                    sendBtn.disabled = false;
                };
                container.appendChild(btn);
            });
            break;
        }
    }
}
function sendMessage() {
    const messageText = messageInput.value.trim();
    if (messageText && currentUser) {
        const timestamp = Date.now();
        
        // Шифруем сообщение перед отправкой
        const encryptedText = encryptMessage(messageText);
        
        // Определяем, в каком режиме мы находимся
        let messagePath = 'messages'; // По умолчанию общий чат
        let messageData = {
            text: encryptedText,
            name: currentUser,
            userId: userId,
            timestamp: timestamp,
            isDeveloper: isDeveloper,
            isTester: isTester,
            userColor: userColor,
            avatar: userAvatarUrl,
            quotedMessage: quotedMessage ? {
                id: quotedMessage.id,
                name: quotedMessage.name,
                text: encryptMessage(quotedMessage.text)
            } : null
        };

        // Если активен приватный чат, меняем путь и добавляем получателя
        if (isPrivateChatActive && privateChatWithUserId) {
            messagePath = `privateMessages/${getPrivateChatId(userId, privateChatWithUserId)}`;
            messageData.recipientId = privateChatWithUserId;
            messageData.recipientName = privateChatWithUserName;
        }
        
        // ОЧЕНЬ ВАЖНО: очищаем поле ввода ДО отправки
        messageInput.value = '';
        quotedMessage = null;
        sendBtn.disabled = true;
        
        // Отправляем сообщение в базу данных
        database.ref(messagePath).push(messageData, (error) => {
            if (error) {
                console.error("Ошибка отправки сообщения:", error);
                showNotification("Ошибка отправки сообщения");
            } else {
            // Обновляем информацию о приватном чате
if (isPrivateChatActive && privateChatWithUserId) {
    const privateChatData = {
        userId: privateChatWithUserId,
        userName: privateChatWithUserName,
        lastActivity: timestamp,
        lastMessage: messageText.substring(0, 30) + (messageText.length > 30 ? "..." : ""),
        withUser: userId
    };
    
    database.ref('privateChats/' + userId + '/' + privateChatWithUserId).set(privateChatData);
    database.ref('privateChats/' + privateChatWithUserId + '/' + userId).set({
        userId: userId,
        userName: currentUser,
        lastActivity: timestamp,
        lastMessage: messageText.substring(0, 30) + (messageText.length > 30 ? "..." : ""),
        withUser: privateChatWithUserId
    });
}
                // Прокручиваем к последнему сообщению
                scrollToBottom();
                
                // Обновляем счетчик сообщений в профиле
                updateMessageCount();
                
                // Проверяем достижения
                checkAchievements();
                // Обновляем счетчик сообщений в профиле
updateMessageCount();

// ПРЯМО ЗДЕСЬ ДОБАВЬ СТРОЧКУ ↓
addXP(5, 'сообщение'); // Добавляем 5 XP за каждое сообщение

// Проверяем достижения
checkAchievements();
                
               
            }
        });
    }
}      
        // Отправка подарка
        function sendGift(gift, type, recipientId, recipientName) {
            if (!currentUser) return;
            
            // Проверяем доступность NFT
            if (type === 'nft' && nftAvailable <= 0) {
                showNotification("У вас нет доступных NFT подарков");
                return;
            }
            
            const timestamp = Date.now();
            
            const giftData = {
                type: 'gift',
                gift: gift,
                giftType: type,
                name: currentUser,
                userId: userId,
                timestamp: timestamp,
                isDeveloper: isDeveloper,
                isTester: isTester,
                userColor: userColor,
                avatar: userAvatarUrl,
                recipientId: recipientId,
                recipientName: recipientName
            };
            
            // Отправляем подарок в базу данных
            database.ref('messages').push(giftData, (error) => {
                if (error) {
                    console.error("Ошибка отправки подарка:", error);
                    showNotification("Ошибка отправки подарка");
                } else {
                    // Уменьшаем количество NFT, если это NFT подарок
                    if (type === 'nft') {
                        nftAvailable--;
                        localStorage.setItem('quantumNftCount', nftAvailable);
                        updateNftCounter();
                    }
                    
                    // Воспроизводим звук подарка
                    playGiftSound();
                    
                    // Проверяем достижения для подарков
                    checkGiftAchievements(type);
                    
                    showNotification(`Подарок отправлен пользователю ${recipientName}!`);
                    
                    // Обновляем статистику подарков в профиле получателя
                    updateRecipientGiftStats(recipientId);
                    addXP(10, 'подарок');
                }
            });
        }
        
        // Обновление статистики подарков для получателя
        function updateRecipientGiftStats(recipientId) {
            if (!recipientId) return;
            
            const recipientProfileRef = database.ref('profiles/' + recipientId);
            recipientProfileRef.transaction((profile) => {
                if (profile) {
                    profile.giftsReceived = (profile.giftsReceived || 0) + 1;
                    profile.lastGiftTime = Date.now();
                }
                return profile;
            });
        }
        
        // Проверка достижений для подарков
        function checkGiftAchievements(type) {
            const userProfileRef = database.ref('profiles/' + userId);
            userProfileRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) return;
                
                const profile = snapshot.val();
                const achievements = profile.achievements || {};
                const giftCount = (profile.giftCount || 0) + 1;
                
                // Обновляем счетчик подарков
                userProfileRef.update({ giftCount: giftCount });
                
                // Проверяем достижения
                if (giftCount >= 10 && !achievements.gift_master) {
                    achievements.gift_master = true;
                    showNotification("🎉 Вы получили достижение 'Щедрый'!");
                }
                
                if (type === 'nft' && !achievements.nft_collector) {
                    achievements.nft_collector = true;
                    showNotification("🎉 Вы получили достижение 'NFT Коллекционер'!");
                }
                
                // Сохраняем обновленные достижения
                userProfileRef.update({ achievements: achievements });
            });
        }
        
        // Обновление счетчика сообщений пользователя
        function updateMessageCount() {
            const userProfileRef = database.ref('profiles/' + userId);
            userProfileRef.transaction((profile) => {
                if (profile) {
                    profile.messageCount = (profile.messageCount || 0) + 1;
                    profile.lastMessageTime = Date.now();
                }
                return profile;
            });
        }
        
        // Проверка достижений
        function checkAchievements() {
            const userProfileRef = database.ref('profiles/' + userId);
            userProfileRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) return;
                
                const profile = snapshot.val();
                const achievements = profile.achievements || {};
                const messageCount = profile.messageCount || 0;
                
                // Проверяем различные достижения
                if (messageCount >= 1 && !achievements.first_message) {
                    achievements.first_message = true;
                    showNotification("🎉 Вы получили достижение 'Первый шаг'!");
                }
                
                if (messageCount >= 100 && !achievements.chatty) {
                    achievements.chatty = true;
                    showNotification("🎉 Вы получили достижение 'Общительный'!");
                }
                
                // Сохраняем обновленные достижения
                userProfileRef.update({ achievements: achievements });
            });
        }
        
        // Очистка чата (только для разработчиков)
        function clearChat() {
            if (isDeveloper) {
                if (confirm("Вы уверены, что хотите очистить весь чат?")) {
                    database.ref('messages').remove((error) => {
                        if (error) {
                            console.error("Ошибка очистки чата:", error);
                            showNotification("Ошибка очистки чата");
                        } else {
                            // Мгновенно очищаем контейнер сообщений
                            messagesContainer.innerHTML = '<div class="empty-chat"><i class="fas fa-comments"></i><p>Чат пуст. Будьте первым, кто отправит сообщение!</p></div>';
                            
                            // Добавляем системное сообщение об очистке
                            const timestamp = Date.now();
                            const systemMessage = {
                                text: `Чат был очищен разработчиком ${currentUser}`,
                                name: "Система",
                                timestamp: timestamp,
                                isSystem: true
                            };
                            
                            database.ref('messages').push(systemMessage);
                            
                            // Показываем уведомление
                            showNotification("Чат был очищен");
                        }
                    });
                }
            } else {
                alert("У вас нет прав для очистки чата");
            }
        }
        
        // Загрузка сообщений из базы данных
        function loadMessages() {
            // Удаляем предыдущий слушатель, если он есть
            if (messagesListener) {
                database.ref('messages').off('child_added', messagesListener);
            }
            
            messagesListener = database.ref('messages').orderByChild('timestamp').limitToLast(100).on('child_added', (snapshot) => {
                if (!snapshot || !snapshot.val()) return;
                
                const message = snapshot.val();
                message.id = snapshot.key;
                
                // Убираем сообщение о пустом чате
                if (messagesContainer.querySelector('.empty-chat')) {
                    messagesContainer.innerHTML = '';
                }
                
                // Дешифруем сообщение
                if (!message.isSystem && message.type !== 'gift') {
                    message.text = decryptMessage(message.text);
                    
                    // Дешифруем цитату, если есть
                    if (message.quotedMessage) {
                        message.quotedMessage.text = decryptMessage(message.quotedMessage.text);
                    }
                }
                
                addMessageToChat(message);
                
                // Автопрокрутка к последнему сообщению
                const isScrolledToBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 100;
                if (isScrolledToBottom || message.userId === userId || isFirstLoad) {
                    scrollToBottom();
                    isFirstLoad = false;
                }
                
                // Воспроизводим звук уведомления, если окно не в фокусе
                if (document.hidden && message.userId !== userId) {
                    playNotificationSound();
                    
                    // Показываем уведомление в браузере
                    if ("Notification" in window && Notification.permission === "granted") {
                        new Notification(`Quantum Messenger: Новое сообщение от ${message.name}`, {
                            body: message.type === 'gift' ? 'Отправил подарок' : message.text,
                            icon: 'https://example.com/icon.png' // Замените на свою иконку
                        });
                    }
                }
            });
            
            // Слушаем удаление сообщений
            if (messageDeleteListener) {
                database.ref('messages').off('child_removed', messageDeleteListener);
            }
            
            messageDeleteListener = database.ref('messages').on('child_removed', (snapshot) => {
                if (!snapshot) return;
                
                const messageId = snapshot.key;
                const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                
                // Если сообщений не осталось, показываем сообщение о пустом чате
                if (messagesContainer.children.length === 0) {
                    messagesContainer.innerHTML = '<div class="empty-chat"><i class="fas fa-comments"></i><p>Чат пуст. Будьте первым, кто отправит сообщение!</p></div>';
                }
            });
            
            // Слушаем изменения сообщений (для редактирования)
            if (messageEditListener) {
                database.ref('messages').off('child_changed', messageEditListener);
            }
            
            messageEditListener = database.ref('messages').on('child_changed', (snapshot) => {
                if (!snapshot || !snapshot.val()) return;
                
                const updatedMessage = snapshot.val();
                updatedMessage.id = snapshot.key;
                
                // Дешифруем сообщение
                if (!updatedMessage.isSystem && updatedMessage.type !== 'gift') {
                    updatedMessage.text = decryptMessage(updatedMessage.text);
                    
                    // Дешифруем цитату, если есть
                    if (updatedMessage.quotedMessage) {
                        updatedMessage.quotedMessage.text = decryptMessage(updatedMessage.quotedMessage.text);
                    }
                }
                
                // Обновляем сообщение в чате
                const messageElement = document.querySelector(`.message[data-id="${updatedMessage.id}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                addMessageToChat(updatedMessage);
            });
        }
        
        // Добавление сообщение в чат
        function addMessageToChat(message) {
        // Очищаем умные ответы при отправке
const replyContainer = document.getElementById('smartRepliesContainer');
if (replyContainer) {
    replyContainer.innerHTML = '';
}
            const messageElement = document.createElement('div');
            const isMyMessage = message.userId === userId;
            const isSystem = message.isSystem;
            const isGift = message.type === 'gift';
            
            if (isSystem) {
                messageElement.classList.add('system-message');
                messageElement.textContent = message.text;
            } else if (isGift) {
                // Обработка сообщения о подарке
                messageElement.classList.add('message');
                messageElement.classList.add(isMyMessage ? 'my-message' : 'other-message');
                if (message.giftType === 'nft') {
                    messageElement.classList.add('nft');
                }
                // Показываем умные ответы для обычных сообщений от других пользователей
if (!isSystem && !isGift && !isMyMessage) {
    setTimeout(() => {
        showSmartReplies(message.text);
    }, 300);
}
                
                // Форматируем время
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Создаем HTML для отправителя
                let senderHTML = '';
                if (!isMyMessage) {
                    let avatarContent = '';
                    if (message.avatar) {
                        if (message.avatar.startsWith('http') || message.avatar.startsWith('data:')) {
                            avatarContent = `<img src="${message.avatar}" class="avatar-img">`;
                        } else {
                            avatarContent = message.avatar;
                        }
                    } else {
                        avatarContent = message.name.charAt(0).toUpperCase();
                    }
                    
                    senderHTML = `
                        <div class="sender" onclick="showUserProfile('${message.userId}')">
                            <div class="user-avatar" style="background: ${message.userColor || '#4facfe'}">
                                ${avatarContent}
                            </div>
                            ${message.name}
                    `;
                    if (message.isDeveloper) {
                        senderHTML += `<span class="verified-badge">✓</span> <span class="developer-badge">Разработчик</span>`;
                    }
                    if (message.isTester) {
                        senderHTML += `<span class="tester-badge">Тестер</span>`;
                    }
                    senderHTML += `</div>`;
                }
                
                // Определяем текст в зависимости от получателя
                let giftText = '';
                if (message.recipientId && message.recipientId !== message.userId) {
                    // Подарок для другого пользователя
                    giftText = isMyMessage ? 
                        `Вы отправили подарок пользователю ${message.recipientName}` : 
                        `Отправил(а) подарок пользователю ${message.recipientName}`;
                } else {
                    // Подарок для всех (или для себя)
                    giftText = isMyMessage ? 'Вы отправили подарок' : 'Отправил(а) подарок';
                }
                
                // Специальная анимация для кубка
                const giftContentClass = (message.gift === '🏆' && message.giftType === 'nft') ? 'gift-content trophy-gift' : 'gift-content';
                
                // Заполняем содержимое сообщения о подарке
                messageElement.innerHTML = `
                    ${senderHTML}
                    <div class="gift-message ${message.giftType === 'nft' ? 'nft' : ''}">
                        <div class="gift-sender">${giftText}:</div>
                        <div class="${giftContentClass}">${message.gift}</div>
                    </div>
                    <div class="timestamp">${time}</div>
                `;
            } else {
                // Обычное текстовое сообщение
                messageElement.classList.add('message');
                messageElement.classList.add(isMyMessage ? 'my-message' : 'other-message');
                messageElement.dataset.id = message.id;
                
                // Добавляем цветовую метку для сообщений других пользователей
                if (!isMyMessage && message.userColor) {
                    messageElement.style.borderLeft = `3px solid ${message.userColor}`;
                }
                
                // Форматируем время
                const time = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Создаем HTML для отправителя
                let senderHTML = '';
                if (!isMyMessage) {
                    let avatarContent = '';
                    if (message.avatar) {
                        if (message.avatar.startsWith('http') || message.avatar.startsWith('data:')) {
                            avatarContent = `<img src="${message.avatar}" class="avatar-img">`;
                        } else {
                            avatarContent = message.avatar;
                        }
                    } else {
                        avatarContent = message.name.charAt(0).toUpperCase();
                    }
                    
                    senderHTML = `
                        <div class="sender" onclick="showUserProfile('${message.userId}')">
                            <div class="user-avatar" style="background: ${message.userColor || '#4facfe'}">
                                ${avatarContent}
                            </div>
                            ${message.name}
                    `;
                    if (message.isDeveloper) {
                        senderHTML += `<span class="verified-badge">✓</span> <span class="developer-badge">Разработчик</span>`;
                    }
                    if (message.isTester) {
                        senderHTML += `<span class="tester-badge">Тестер</span>`;
                    }
                    senderHTML += `</div>`;
                }
                
                // Добавляем цитату, если есть
                let quoteHTML = '';
                if (message.quotedMessage) {
                    quoteHTML = `
                        <div class="quote-container">
                            <div class="quote-author">${message.quotedMessage.name}:</div>
                            <div class="quote-text">${escapeHtml(message.quotedMessage.text)}</div>
                        </div>
                    `;
                }
                
                // Добавляем действия с сообщением (редактирование, удаление, ответ)
                let actionsHTML = '';
                if (isMyMessage) {
                    actionsHTML = `
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="editMessage('${message.id}')">
                                <i class="fas fa-edit"></i>
                                
                            </button>
                           
<button class="message-action-btn" onclick="addToFavorites('${message.id}')">
    <i class="fas fa-star"></i>
</button>
                            <button class="message-action-btn" onclick="deleteMessage('${message.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                } else {
                    actionsHTML = `
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="replyToMessage('${message.id}')">
                                <i class="fas fa-reply"></i>
                                
                            </button>
                        </div>
                   
                    `;
                }
                
                // Добавляем реакции, если есть
                
                if (message.reactions) {
                    reactionsHTML = '<div class="reactions">';
                    for (const [emoji, users] of Object.entries(message.reactions)) {
                        const userReacted = users && users[userId];
                        reactionsHTML += `
                            <div class="reaction ${userReacted ? 'active' : ''}" onclick="toggleReaction('${message.id}', '${emoji}')">
                                ${emoji} <span>${users ? Object.keys(users).length : 0}</span>
                            </div>
                        `;
                    }
                    reactionsHTML += '</div>';
                }
                
                // Добавляем индикатор голосового сообщения, если есть
                let voiceMessageHTML = '';
                if (message.voiceMessage) {
                    voiceMessageHTML = `
                        <div class="voice-message-indicator">
                            <button class="voice-message-btn" onclick="playVoiceMessage('${message.voiceMessage}')">
                                <i class="fas fa-play"></i> Голосовое сообщение
                            </button>
                        </div>
                    `;
                }
                
                // Добавляем отметку об редактировании, если есть
                let editedHTML = '';
                if (message.edited) {
                    editedHTML = '<span style="font-size: 9px; opacity: 0.7; margin-left: 5px;">(изменено)</span>';
                }
                
                // Заполняем содержимое сообщения
                // Добавляем реакции, если есть
let reactionsHTML = '';
if (message.reactions) {
    reactionsHTML = '<div class="reactions">';
    for (const [emoji, users] of Object.entries(message.reactions)) {
        const userReacted = users && users[userId];
        reactionsHTML += `
            <div class="reaction ${userReacted ? 'active' : ''}" onclick="toggleReaction('${message.id}', '${emoji}')">
                ${emoji} <span>${users ? Object.keys(users).length : 0}</span>
            </div>
        `;
    }
    reactionsHTML += '</div>';
}

// Заполняем содержимое сообщения
messageElement.innerHTML = `
    ${actionsHTML}
    ${senderHTML}
    ${quoteHTML}
    ${escapeHtml(message.text)}
    ${editedHTML}
    ${voiceMessageHTML}
    ${reactionsHTML}
    <div class="timestamp">${time}</div>
`;
                
                // Подсвечиваем текст, если активен поиск
                if (searchActive && searchTerm) {
                    const text = messageElement.innerHTML;
                    const regex = new RegExp(escapeRegExp(searchTerm), 'gi');
                    messageElement.innerHTML = text.replace(regex, match => 
                        `<span class="highlight">${match}</span>`
                    );
                }
                
                // Добавляем обработчик двойного клика для быстрого ответа
                messageElement.addEventListener('dblclick', () => {
                    if (!isMyMessage) {
                        replyToMessage(message.id);
                    }
                });
            }
            
            // Добавляем сообщение в контейнер
            messagesContainer.appendChild(messageElement);
        }
        
        // Настройка онлайн-пользователей
        function setupOnlineUsers() {
            const userStatusRef = database.ref('onlineUsers/' + userId);
            
            // Устанавливаем статус пользователя как онлайн
            userStatusRef.set({
                name: currentUser,
                isDeveloper: isDeveloper,
                isTester: isTester,
                lastOnline: Date.now()
            });
            
            // Удаляем пользователя при выходе
            userStatusRef.onDisconnect().remove();
            
            // Удаляем предыдущий слушатель, если он есть
            if (onlineUsersListener) {
                database.ref('onlineUsers').off('value', onlineUsersListener);
            }
            
            // Следим за количеством онлайн-пользователей
            onlineUsersListener = database.ref('onlineUsers').on('value', (snapshot) => {
                if (!snapshot) return;
                
                const users = snapshot.val();
                const count = users ? Object.keys(users).length : 0;
                onlineCount.textContent = count;
            });
        }
        
        // Настройка системы профилей
        function setupProfiles() {
            // Создаем или обновляем профиль пользователя
            const userProfileRef = database.ref('profiles/' + userId);
            
            userProfileRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    // Создаем новый профиль
                    userProfileRef.set({
                        name: currentUser,
                        avatar: userAvatarUrl,
                        registeredAt: Date.now(),
                        lastOnline: Date.now(),
                        isOnline: true,
                        messageCount: 0,
                        giftCount: 0,
                        giftsReceived: 0,
                        isDeveloper: isDeveloper,
                        isTester: isTester,
                        achievements: {
                            first_message: false,
                            chatty: false,
                            popular: false,
                            early_bird: false,
                            developer: isDeveloper,
                            voice: false,
                            gift_master: false,
                            nft_collector: false
                        }
                    });
                } else {
                    // Обновляем существующий профиль
                    userProfileRef.update({
                        name: currentUser,
                        avatar: userAvatarUrl,
                        lastOnline: Date.now(),
                        isOnline: true,
                        isDeveloper: isDeveloper,
                        isTester: isTester
                    });
                }
            });
            
            // Обновляем статус при выходе
            userProfileRef.onDisconnect().update({
                isOnline: false,
                lastOnline: Date.now()
            });
        }
        
        // Показать профиль пользователя
        function showUserProfile(profileUserId) {
            const profileRef = database.ref('profiles/' + profileUserId);
            profileRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) return;
                
                const profile = snapshot.val();
                currentProfileView = profileUserId;
                
                // Заполняем данные профиля
                profileName.textContent = profile.name;
                
                // Устанавливаем аватар
                if (profile.avatar) {
                    if (profile.avatar.startsWith('http') || profile.avatar.startsWith('data:')) {
                        profileAvatarImg.src = profile.avatar;
                        profileAvatarImg.style.display = 'block';
                        profileAvatarInitial.style.display = 'none';
                    } else {
                        profileAvatarInitial.textContent = profile.avatar;
                        profileAvatarImg.style.display = 'none';
                        profileAvatarInitial.style.display = 'block';
                    }
                } else {
                    profileAvatarInitial.textContent = profile.name.charAt(0).toUpperCase();
                    profileAvatarImg.style.display = 'none';
                    profileAvatarInitial.style.display = 'block';
                }
                
                profileAvatar.style.background = generateUserColor();
                
                // Статус
                if (profile.status && profile.isOnline) {
    // Показываем кастомный статус если пользователь онлайн
    const statusNames = {
        'online': 'Онлайн',
        'away': 'Отошёл', 
        'busy': 'Занят',
        'dnd': 'Не беспокоить'
    };
    
    const statusColors = {
        'online': '#4CAF50',
        'away': '#FF9800', 
        'busy': '#F44336',
        'dnd': '#9E9E9E'
    };
    
    profileStatus.textContent = statusNames[profile.status] || 'Онлайн';
    profileStatus.style.color = statusColors[profile.status] || '#4CAF50';
} else {
    // Стандартный онлайн/оффлайн
    profileStatus.textContent = profile.isOnline ? 'Онлайн' : 'Оффлайн';
    profileStatus.style.color = profile.isOnline ? '#4CAF50' : '#ccc';
}
                
                // Количество сообщений
                profileMessageCount.textContent = profile.messageCount || 0;
                
                // Дата регистрации
                if (profile.registeredAt) {
                    const regDate = new Date(profile.registeredAt);
                    profileRegistered.textContent = regDate.toLocaleDateString();
                    
                    // Рассчитываем сколько дней прошло с регистрации
                    const now = new Date();
                    const daysSinceReg = Math.floor((now - regDate) / (1000 * 60 * 60 * 24));
                    statDays.textContent = daysSinceReg;
                    
                    // Среднее количество сообщений в день
                    const avgMessages = (profile.messageCount || 0) / (daysSinceReg || 1);
                    statAvg.textContent = avgMessages.toFixed(1);
                }
                
                // Последняя активность
                if (profile.lastOnline) {
                    const lastOnlineDate = new Date(profile.lastOnline);
                    const now = new Date();
                    const diffMs = now - lastOnlineDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    if (profile.isOnline) {
                        profileLastOnline.textContent = 'Сейчас онлайн';
                    } else if (diffMins < 1) {
                        profileLastOnline.textContent = 'Только что';
                    } else if (diffMins < 60) {
                        profileLastOnline.textContent = `${diffMins} мин. назад`;
                    } else {
                        profileLastOnline.textContent = lastOnlineDate.toLocaleDateString();
                    }
                }
                
                // Загружаем заметку о пользователе
                userNote.value = loadUserNote(profileUserId);
                
                // Бейджи
                profileBadges.innerHTML = '';
                if (profile.isDeveloper) {
                    const badge = document.createElement('div');
                    badge.classList.add('profile-badge', 'badge-developer');
                    badge.textContent = 'Разработчик';
                    profileBadges.appendChild(badge);
                }
                if (profile.isTester) {
                    const badge = document.createElement('div');
                    badge.classList.add('profile-badge', 'badge-tester');
                    badge.textContent = 'Тестер';
                    profileBadges.appendChild(badge);
                }
                
                // Дополнительные бейджи на основе активности
                if (profile.messageCount > 50) {
                    const badge = document.createElement('div');
                    badge.classList.add('profile-badge', 'badge-chatty');
                    badge.textContent = 'Общительный';
                    profileBadges.appendChild(badge);
                }
                
                if (profile.isOnline) {
                    const badge = document.createElement('div');
                    badge.classList.add('profile-badge', 'badge-active');
                    badge.textContent = 'Активный';
                    profileBadges.appendChild(badge);
                }
                
                // Действия
                profileActions.innerHTML = '';
                
                // Кнопка "Подарить" только если это не наш профиль
                if (profileUserId !== userId) {
                    const giveGiftBtn = document.createElement('button');
                    giveGiftBtn.classList.add('profile-action-btn', 'primary');
                    giveGiftBtn.innerHTML = '<i class="fas fa-gift"></i> Подарить';
                    giveGiftBtn.addEventListener('click', () => {
                        // Открываем модальное окно подарка с предвыбранным получателем
                        loadOnlineUsersForGifts(profileUserId);
                        giftModal.classList.add('active');
                        profileModal.classList.remove('active');
                    });
                    profileActions.appendChild(giveGiftBtn);
                }
        // Кнопка "Личное сообщение"
const privateChatBtn = document.createElement('button');
privateChatBtn.classList.add('profile-action-btn', 'primary');
privateChatBtn.innerHTML = '<i class="fas fa-comment"></i> Личное сообщение';
privateChatBtn.addEventListener('click', () => {
    enterPrivateChat(profileUserId, profile.name);
    profileModal.classList.remove('active');
});
profileActions.appendChild(privateChatBtn);        
                // Кнопка закрытия
                const closeBtn = document.createElement('button');
                closeBtn.classList.add('profile-action-btn', 'secondary');
                closeBtn.textContent = 'Закрыть';
                closeBtn.addEventListener('click', () => {
                    profileModal.classList.remove('active');
                    // Сохраняем заметку о пользователе
                    saveUserNote(profileUserId);
                });
                profileActions.appendChild(closeBtn);
                
                // Показываем модальное окно
                profileModal.classList.add('active');
                
                // Загружаем дополнительные данные (подарки, медиа, достижения)
                loadUserGifts(profileUserId);
                loadUserMedia(profileUserId);
                loadUserAchievements(profileUserId);
                loadUserStats(profileUserId);
                
            }).catch((error) => {
                console.error("Ошибка загрузки профиля:", error);
                showNotification("Ошибка загрузки профиля");
            });
        }
        
        // Загрузка статистики пользователя
        function loadUserStats(userId) {
            // В реальном приложении здесь бы загружалась статистика активности
            // Для демонстрации генерируем случайные данные
            statReactions.textContent = Math.floor(Math.random() * 20);
            statVoice.textContent = Math.floor(Math.random() * 5);
            
            // Генерируем случайную диаграмму активности
            const chartBars = activityChart.querySelectorAll('.chart-bar');
            chartBars.forEach(bar => {
                const height = Math.floor(Math.random() * 80) + 10;
                bar.style.height = `${height}%`;
            });
        }
        
        // Загрузка подарков пользователя
        function loadUserGifts(userId) {
            giftsList.innerHTML = '<div class="loading"><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div>';
            
            // В реальном приложении здесь бы загружались подарки из базы данных
            // Для демонстрации используем временные данные
            setTimeout(() => {
                giftsList.innerHTML = '';
                
                const demoGifts = [
                    { gift: '🎁', sender: 'Алексей', time: '2 часа назад', type: 'regular' },
                    { gift: '❤️', sender: 'Мария', time: '5 часов назад', type: 'regular' },
                    { gift: '🏆', sender: 'Иван', time: '1 день назад', type: 'nft' },
                    { gift: '🎉', sender: 'Ольга', time: '2 дня назад', type: 'regular' },
                    { gift: '⭐', sender: 'Дмитрий', time: '3 дня назад', type: 'nft' },
                    { gift: '👑', sender: 'Елена', time: '4 дня назад', type: 'nft' }
                ];
                
                demoGifts.forEach(gift => {
                    const giftItem = document.createElement('div');
                    giftItem.classList.add('gift-item');
                    if (gift.type === 'nft') {
                        giftItem.classList.add('nft');
                    }
                    
                    giftItem.innerHTML = `
                        <div class="gift-item-content">${gift.gift}</div>
                        <div class="gift-item-sender">От: ${gift.sender}</div>
                        <div class="gift-item-time">${gift.time}</div>
                        <div class="gift-item-type">${gift.type === 'nft' ? 'NFT' : 'Обычный'}</div>
                    `;
                    
                    giftsList.appendChild(giftItem);
                });
            }, 1000);
        }
        
        // Загрузка медиафайлов пользователя
        function loadUserMedia(userId) {
            mediaGrid.innerHTML = '';
            
            // В реальном приложении здесь бы загружались медиафайлы из базы данных
            // Для демонстрации используем временные данные
            for (let i = 0; i < 6; i++) {
                const mediaItem = document.createElement('div');
                mediaItem.classList.add('media-item');
                mediaItem.innerHTML = '<i class="fas fa-image"></i>';
                mediaGrid.appendChild(mediaItem);
            }
        }
        
        // Загрузка достижений пользователя
        function loadUserAchievements(userId) {
            achievementList.innerHTML = '';
            
            // В реальном приложении здесь бы загружались достижения из базы данных
            // Для демонстрации используем временные данные
            achievements.forEach(achievement => {
                const achievementItem = document.createElement('div');
                achievementItem.classList.add('achievement-item');
                
                achievementItem.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-title">${achievement.title}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                    </div>
                `;
                
                achievementList.appendChild(achievementItem);
            });
        }
        
        // Настройка индикатора набора текста
        function setupTypingIndicator() {
            // Удаляем предыдущий слушатель, если он есть
            if (typingListener) {
                database.ref('typing').off('child_added', typingListener);
                database.ref('typing').off('child_removed', typingListener);
            }
            
            let typingUsers = {};
            
            typingListener = database.ref('typing').on('child_added', (snapshot) => {
                if (!snapshot || !snapshot.val()) return;
                
                const typingData = snapshot.val();
                if (typingData.name !== currentUser) {
                    typingUsers[snapshot.key] = typingData.name;
                    updateTypingIndicator();
                }
            });
            
            database.ref('typing').on('child_removed', (snapshot) => {
                if (!snapshot) return;
                
                delete typingUsers[snapshot.key];
                updateTypingIndicator();
            });
            
            function updateTypingIndicator() {
                const count = Object.keys(typingUsers).length;
                if (count > 0) {
                    const names = Object.values(typingUsers);
                    let text = '';
                    
                    if (count === 1) {
                        text = `${names[0]} печатает...`;
                    } else if (count === 2) {
                        text = `${names[0]} и ${names[1]} печатают...`;
                    } else {
                        text = `${names[0]}, ${names[1]} и еще ${count - 2} печатают...`;
                    }
                    
                    typingIndicator.textContent = text;
                } else {
                    typingIndicator.textContent = '';
                }
            }
        }
        
        // Переключение темы
        function toggleTheme() {
            if (document.body.classList.contains('light-theme')) {
                document.body.classList.remove('light-theme');
                themeToggle.textContent = '🌙';
                localStorage.setItem('quantumTheme', 'dark');
            } else {
                document.body.classList.add('light-theme');
                themeToggle.textContent = '☀️';
                localStorage.setItem('quantumTheme', 'light');
            }
        }
        
        // Переключение записи голоса
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        // Начало записи голоса
        function startRecording() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        audioChunks = [];
                        mediaRecorder = new MediaRecorder(stream);
                        
                        mediaRecorder.ondataavailable = (event) => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            uploadVoiceMessage(audioBlob);
                        };
                        
                        mediaRecorder.start();
                        isRecording = true;
                        voiceRecordBtn.classList.add('recording');
                        voiceRecordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                    })
                    .catch(error => {
                        console.error("Ошибка доступа к микрофону:", error);
                        showNotification("Не удалось получить доступ к микрофону");
                    });
            } else {
                showNotification("Ваш браузер не поддерживает запись голоса");
            }
        }
        
        // Остановка записи голоса
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                voiceRecordBtn.classList.remove('recording');
                voiceRecordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                
                // Останавливаем все треки микрофона
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }
        
        // Загрузка голосового сообщения
        function uploadVoiceMessage(audioBlob) {
            // В реальном приложении здесь бы загружалось аудио на сервер
            // Для демонстрации просто отправляем сообщение с меткой о голосовом сообщении
            
            const timestamp = Date.now();
            
            const messageData = {
                text: encryptMessage("Голосовое сообщение"),
                name: currentUser,
                userId: userId,
                timestamp: timestamp,
                isDeveloper: isDeveloper,
                isTester: isTester,
                userColor: userColor,
                avatar: userAvatarUrl,
                voiceMessage: "voice_" + timestamp + ".webm" // В реальном приложении это была бы ссылка на аудиофайл
            };
            
            // Отправляем сообщение в базу данных
            database.ref('messages').push(messageData, (error) => {
                if (error) {
                    console.error("Ошибка отправки голосового сообщения:", error);
                    showNotification("Ошибка отправки голосового сообщения");
                } else {
                    // Обновляем счетчик голосовых сообщений в профиле
                    updateVoiceMessageCount();
                    
                    showNotification("Голосовое сообщение отправлено");
                }
            });
        }
        
        // Обновление счетчика голосовых сообщений
        function updateVoiceMessageCount() {
            const userProfileRef = database.ref('profiles/' + userId);
            userProfileRef.transaction((profile) => {
                if (profile) {
                    profile.voiceMessageCount = (profile.voiceMessageCount || 0) + 1;
                }
                return profile;
            });
        }
        
        // Воспроизведение голосового сообщения
        function playVoiceMessage(audioUrl) {
            // В реальном приложении здесь бы воспроизводилось аудио с сервера
            // Для демонстрации просто показываем уведомление
            showNotification("Воспроизведение голосового сообщения...");
        }
        
        // Выполнение поиска
        function performSearch() {
            const term = searchInput.value.trim();
            if (term) {
                searchActive = true;
                searchTerm = term;
                
                // Перезагружаем сообщения для подсветки
                messagesContainer.innerHTML = '';
                database.ref('messages').orderByChild('timestamp').limitToLast(100).once('value').then((snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        const message = childSnapshot.val();
                        message.id = childSnapshot.key;
                        messages.push(message);
                    });
                    
                    // Сортируем по времени
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Добавляем сообщения в чат
                    messages.forEach(message => {
                        // Дешифруем сообщение
                        if (!message.isSystem && message.type !== 'gift') {
                            message.text = decryptMessage(message.text);
                            
                            // Дешифруем цитату, если есть
                            if (message.quotedMessage) {
                                message.quotedMessage.text = decryptMessage(message.quotedMessage.text);
                            }
                        }
                        
                        addMessageToChat(message);
                    });
                    
                    // Прокручиваем к первому найденному сообщению
                    if (messages.length > 0) {
                        scrollToBottom();
                    }
                });
            }
        }
        
        // Очистка поиска
        function clearSearch() {
            searchInput.value = '';
            searchActive = false;
            searchTerm = '';
            
            // Перезагружаем сообщения без подсветки
            messagesContainer.innerHTML = '';
            loadMessages();
            
            // Скрываем контейнер поиска
            searchContainer.style.display = 'none';
        }
        
        // Отображение вариантов аватаров
        function renderAvatarOptions() {
            avatarOptions.innerHTML = '';
            
            defaultAvatars.forEach(avatar => {
                const option = document.createElement('div');
                option.classList.add('avatar-option');
                if (avatar === userAvatarUrl) {
                    option.classList.add('selected');
                }
                option.textContent = avatar;
                option.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                });
                avatarOptions.appendChild(option);
            });
        }
        
        // Сохранение аватара
        function saveAvatar() {
            const selectedOption = document.querySelector('.avatar-option.selected');
            if (selectedOption) {
                userAvatarUrl = selectedOption.textContent;
                localStorage.setItem('quantumAvatar', userAvatarUrl);
                
                // Обновляем отображение аватара
                updateAvatarDisplay();
                
                // Обновляем профиль в базе данных
                if (userId) {
                    database.ref('profiles/' + userId).update({
                        avatar: userAvatarUrl
                    });
                }
                
                // Закрываем модальное окно
                avatarModal.classList.remove('active');
                
                showNotification("Аватар обновлен");
            }
        }
        
        // Редактирование сообщения
        function editMessage(messageId) {
            const messageRef = database.ref('messages/' + messageId);
            messageRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) return;
                
                const message = snapshot.val();
                if (message.userId === userId) {
                    const newText = prompt("Редактировать сообщение:", decryptMessage(message.text));
                    if (newText !== null && newText.trim() !== '') {
                        messageRef.update({
                            text: encryptMessage(newText.trim()),
                            edited: true,
                            editTimestamp: Date.now()
                        });
                    }
                } else {
                    alert("Вы можете редактировать только свои сообщения");
                }
            });
        }
        
        // Удаление сообщения
        function deleteMessage(messageId) {
            if (confirm("Вы уверены, что хотите удалить это сообщение?")) {
                const messageRef = database.ref('messages/' + messageId);
                messageRef.once('value').then((snapshot) => {
                    if (!snapshot.exists()) return;
                    
                    const message = snapshot.val();
                    if (message.userId === userId || isDeveloper) {
                        messageRef.remove();
                    } else {
                        alert("Вы можете удалять только свои сообщения");
                    }
                });
            }
        }
        
        // Ответ на сообщение
        function replyToMessage(messageId) {
            const messageRef = database.ref('messages/' + messageId);
            messageRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) return;
                
                const message = snapshot.val();
                quotedMessage = {
                    id: messageId,
                    name: message.name,
                    text: decryptMessage(message.text)
                };
                
                // Фокусируемся на поле ввода и добавляем упоминание
                messageInput.focus();
                messageInput.value = `@${message.name} `;
                sendBtn.disabled = false;
                
                showNotification(`Ответ на сообщение ${message.name}`);
            });
        }
        
        // Переключение реакции на сообщение
        function toggleReaction(messageId, emoji) {
            if (!userId) return;
            
            const reactionRef = database.ref(`messages/${messageId}/reactions/${emoji}/${userId}`);
            reactionRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Убираем реакцию, если она уже есть
                    reactionRef.remove();
                } else {
                    // Добавляем реакцию
                    reactionRef.set(true);
                    
                    // Обновляем счетчик реакций в профиле получателя
                    updateReactionCount(messageId);
                }
            });
        }
        
        // Обновление счетчика реакций
        function updateReactionCount(messageId) {
            const messageRef = database.ref('messages/' + messageId);
            messageRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) return;
                
                const message = snapshot.val();
                if (message.userId && message.userId !== userId) {
                    const userProfileRef = database.ref('profiles/' + message.userId);
                    userProfileRef.transaction((profile) => {
                        if (profile) {
                            profile.reactionsReceived = (profile.reactionsReceived || 0) + 1;
                        }
                        return profile;
                    });
                    
                    // Проверяем достижения для получателя
                    checkReactionAchievements(message.userId);
                }
            });
        }
        // Переключение реакции на сообщение
function toggleReaction(messageId, emoji) {
    if (!userId) return;
    
    const reactionRef = database.ref(`messages/${messageId}/reactions/${emoji}/${userId}`);
    reactionRef.once('value').then((snapshot) => {
        if (snapshot.exists()) {
            // Убираем реакцию, если она уже есть
            reactionRef.remove();
        } else {
            // Добавляем реакцию
            reactionRef.set(true);
            
            // Обновляем счетчик реакций в профиле получателя
            updateReactionCount(messageId);
        }
    });
}

// Обновление счетчика реакций
function updateReactionCount(messageId) {
    const messageRef = database.ref('messages/' + messageId);
    messageRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) return;
        
        const message = snapshot.val();
        if (message.userId && message.userId !== userId) {
            const userProfileRef = database.ref('profiles/' + message.userId);
            userProfileRef.transaction((profile) => {
                if (profile) {
                    profile.reactionsReceived = (profile.reactionsReceived || 0) + 1;
                }
                return profile;
            });
            
            // Проверяем достижения для получателя
            checkReactionAchievements(message.userId);
        }
    });
}
        // Проверка достижений для реакций
        // Проверка достижений для реакций
function checkReactionAchievements(userId) {
    const userProfileRef = database.ref('profiles/' + userId);
    userProfileRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) return;
        
        const profile = snapshot.val();
        const achievements = profile.achievements || {};
        const reactionsCount = profile.reactionsReceived || 0;
        
        // Проверяем достижение "Популярный"
        if (reactionsCount >= 10 && !achievements.popular) {
            achievements.popular = true;
            
            // Отправляем уведомление получателю, если он онлайн
            if (profile.isOnline) {
                database.ref('messages').push({
                    text: `Поздравляем! Вы получили достижение "Популярный" за получение 10 реакций на ваши сообщения`,
                    name: "Система",
                    timestamp: Date.now(),
                    isSystem: true,
                    recipientId: userId
                });
            }
        }
        
        // Сохраняем обновленные достижения
        userProfileRef.update({ achievements: achievements });
    });
}
        
        function showNotification(text, type = 'info', action = null) {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.classList.add('notification');
    if (type === 'private') notification.classList.add('private');
    
    // Добавляем иконку в зависимости от типа
    let icon = '💡';
    if (type === 'success') icon = '✅';
    if (type === 'error') icon = '❌';
    if (type === 'warning') icon = '⚠️';
    if (type === 'gift') icon = '🎁';
    if (type === 'private') icon = '💬';
    
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">${icon}</span> 
            <span class="notification-text">${text}</span>
            ${action ? `<button class="notification-action" onclick="${action}">Открыть</button>` : ''}
        </div>
    `;
    
    // Добавляем уведомление в тело документа
    document.body.appendChild(notification);
    
    // Удаляем уведомление через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
        
        // Воспроизведение звука уведомления
        function playNotificationSound() {
            if (notificationSound) {
                notificationSound.currentTime = 0;
                notificationSound.play().catch(e => console.log("Не удалось воспроизвести звук:", e));
            }
        }
        
        // Воспроизведение звука подарка
        function playGiftSound() {
            if (giftSound) {
                giftSound.currentTime = 0;
                giftSound.play().catch(e => console.log("Не удалось воспроизвести звук:", e));
            }
        }
        
        // Экранирование HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Экранирование для регулярных выражений
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // Обработка изменения видимости страницы
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Страница стала активной, обновляем заголовок
                document.title = "Quantum Messenger";
            }
        });
        
        // Обработка изменения размера окна
        window.addEventListener('resize', () => {
            // При изменении размера окна прокручиваем к последнему сообщению
            scrollToBottom();
        });
        // Функция для создания уникального ID приватного чата
function getPrivateChatId(userId1, userId2) {
    // Сортируем ID, чтобы создать одинаковый ключ для любой пары пользователей
    const sortedIds = [userId1, userId2].sort();
    return sortedIds.join('_');
}

// Функция для входа в приватный чат
function enterPrivateChat(withUserId, withUserName) {
// Сбрасываем счетчик непрочитанных для этого чата
if (privateChatWithUserId) {
    unreadPrivateCount = 0;
    updateUnreadBadge();
}
    isPrivateChatActive = true;
    privateChatWithUserId = withUserId;
    privateChatWithUserName = withUserName;
    
    // Сохраняем информацию о приватном чате в базу данных
    const privateChatData = {
        userId: withUserId,
        userName: withUserName,
        lastActivity: Date.now(),
        lastMessage: "Чат начат",
        withUser: userId // Твой ID
    };
    
    // Сохраняем чат для обоих пользователей
    database.ref('privateChats/' + userId + '/' + withUserId).set(privateChatData);
    database.ref('privateChats/' + withUserId + '/' + userId).set({
        userId: userId,
        userName: currentUser,
        lastActivity: Date.now(),
        lastMessage: "Чат начат",
        withUser: withUserId
    });
    
    // Показываем индикатор приватного чата
    document.getElementById('chatModeIndicator').style.display = 'flex';
    document.getElementById('privateChatWith').textContent = withUserName;
    
    // Меняем заголовок чата
    document.querySelector('.chat-header .user-name span').textContent = `Приватный чат с ${withUserName}`;
    
    // Очищаем сообщения и загружаем приватные
    messagesContainer.innerHTML = '';
    removeAllListeners();
    loadPrivateMessages();
    
    showNotification(`Вы вошли в приватный чат с ${withUserName}`);
}

// Функция для загрузки приватных сообщений
function loadPrivateMessages() {
    const chatId = getPrivateChatId(userId, privateChatWithUserId);
    
    // Удаляем старый слушатель, если он есть
    if (messagesListener) {
        database.ref(`privateMessages/${chatId}`).off('child_added', messagesListener);
    }
    
    // Слушаем новые сообщения в личном чате
    messagesListener = database.ref(`privateMessages/${chatId}`).orderByChild('timestamp').limitToLast(100).on('child_added', (snapshot) => {
        if (!snapshot || !snapshot.val()) return;

        const message = snapshot.val();
        message.id = snapshot.key;

        // Убираем сообщение о пустом чате
        if (messagesContainer.querySelector('.empty-chat')) {
            messagesContainer.innerHTML = '';
        }

        // Дешифруем сообщение
        if (!message.isSystem && message.type !== 'gift') {
            message.text = decryptMessage(message.text);
            if (message.quotedMessage) {
                message.quotedMessage.text = decryptMessage(message.quotedMessage.text);
            }
        }

        // Добавляем сообщение в чат
        addMessageToChat(message);

        // Прокручиваем вниз
        scrollToBottom();
    });

    // Слушаем удаление сообщений в личном чате
    if (messageDeleteListener) {
        database.ref(`privateMessages/${chatId}`).off('child_removed', messageDeleteListener);
    }
    messageDeleteListener = database.ref(`privateMessages/${chatId}`).on('child_removed', (snapshot) => {
        const messageId = snapshot.key;
        const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
        if (messageElement) {
            messageElement.remove();
        }
        if (messagesContainer.children.length === 0) {
            messagesContainer.innerHTML = '<div class="empty-chat"><i class="fas fa-comments"></i><p>Чат пуст. Будьте первым, кто отправит сообщение!</p></div>';
        }
    });
}
// Загрузка избранных сообщений
function loadFavorites() {
    favoritesList.innerHTML = '<div class="loading"><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div>';
    
    const favoritesRef = database.ref('favorites/' + userId);
    favoritesRef.once('value').then((snapshot) => {
        favoritesList.innerHTML = '';
        
        if (!snapshot.exists()) {
            favoritesList.innerHTML = '<div class="empty-chat"><i class="fas fa-star"></i><p>У вас пока нет избранных сообщений</p></div>';
            return;
        }
        
        const favorites = snapshot.val();
        Object.keys(favorites).forEach(messageId => {
            const favorite = favorites[messageId];
            
            const favoriteItem = document.createElement('div');
            favoriteItem.classList.add('favorite-item');
            
            // Дешифруем сообщение
            let messageText = decryptMessage(favorite.message);
            
            favoriteItem.innerHTML = `
                <div class="favorite-sender">От: ${favorite.sender}</div>
                <div class="favorite-text">${escapeHtml(messageText)}</div>
                <div class="favorite-time">Добавлено: ${new Date(favorite.addedAt).toLocaleString()}</div>
                <button class="action-btn" onclick="removeFromFavorites('${messageId}')">
                    <i class="fas fa-trash"></i> Удалить
                </button>
            `;
            
            favoritesList.appendChild(favoriteItem);
        });
    });
}

// Удалить из избранного
function removeFromFavorites(messageId) {
    const favoriteRef = database.ref('favorites/' + userId + '/' + messageId);
    favoriteRef.remove();
    showNotification("Сообщение удалено из избранного");
    loadFavorites(); // Перезагружаем список
}
// Добавить сообщение в избранное
function addToFavorites(messageId) {
    const messageRef = database.ref('messages/' + messageId);
    messageRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) return;
        
        const message = snapshot.val();
        
        // Сохраняем в избранное этого пользователя
        const favoriteRef = database.ref('favorites/' + userId + '/' + messageId);
        favoriteRef.set({
            message: message.text, // сохраняем зашифрованное сообщение
            sender: message.name,
            senderId: message.userId,
            timestamp: message.timestamp,
            addedAt: Date.now()
        });
        
        showNotification("Сообщение добавлено в избранное ★");
    });
}
// ★★★★ УЛУЧШЕННАЯ СИСТЕМА УРОВНЕЙ ★★★★
let userLevel = parseInt(localStorage.getItem('quantumUserLevel')) || 1;
let userXP = parseInt(localStorage.getItem('quantumUserXP')) || 0;
let userRank = localStorage.getItem('quantumUserRank') || 'Новичок';

// Ранги и их требования
const ranks = [
    { name: 'Новичок', minLevel: 1, color: '#95afc0' },
    { name: 'Активный', minLevel: 5, color: '#7bed9f' },
    { name: 'Эксперт', minLevel: 10, color: '#70a1ff' },
    { name: 'Мастер', minLevel: 15, color: '#ff6b81' },
    { name: 'Легенда', minLevel: 20, color: '#eccc68' },
    { name: 'БОГ ЧАТА', minLevel: 25, color: '#ff9ff3' }
];

// Награды за уровни
const levelRewards = {
    5: { nft: 1, message: '🎉 Вы получили 1 NFT за 5 уровень!' },
    10: { nft: 2, message: '🎁 Вы получили 2 NFT за 10 уровень!' },
    15: { nft: 3, message: '🏆 Вы получили 3 NFT за 15 уровень!' },
    20: { nft: 5, message: '🌟 Вы получили 5 NFT за 20 уровень!' },
    25: { nft: 10, message: '💎 Вы получили 10 NFT за 25 уровень! БОГ ЧАТА!' }
};

// Добавление опыта
function addXP(amount, reason = 'сообщение') {
    if (!currentUser) return;
    
    const oldLevel = userLevel;
    userXP += amount;
    
    // Проверяем уровень up
    const xpNeeded = calculateXPNeeded(userLevel);
    
    if (userXP >= xpNeeded) {
        userLevel++;
        userXP = userXP - xpNeeded; // Переносим лишний XP на след. уровень
        
        // Сохраняем
        saveLevelData();
        
        // Показываем крутое уведомление о новом уровне
        showLevelUpNotification(oldLevel, userLevel);
        
        // Проверяем награды
        checkLevelRewards(userLevel);
        
        // Проверяем новый ранг
        checkNewRank();
    } else {
        saveLevelData();
    }
    
    updateLevelDisplay();
}

// Расчет нужного XP для уровня
function calculateXPNeeded(level) {
    return Math.floor(100 * Math.pow(1.2, level - 1));
}

// Показать уведомление о новом уровне
function showLevelUpNotification(oldLevel, newLevel) {
    // Создаем крутое уведомление
    const notification = document.createElement('div');
    notification.className = 'level-up-notification';
    notification.innerHTML = `
        <div class="level-up-content">
            <div class="level-up-icon">🎉</div>
            <div class="level-up-text">
                <h3>НОВЫЙ УРОВЕНЬ!</h3>
                <p>${oldLevel} → <span class="new-level">${newLevel}</span></p>
            </div>
            <div class="level-up-confetti">🎊🎊🎊</div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Запускаем конфетти
    startConfetti();
    
    // Воспроизводим звук
    playSound('levelup');
    
    // Удаляем через 5 секунд
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Проверка наград за уровень
function checkLevelRewards(level) {
    if (levelRewards[level]) {
        const reward = levelRewards[level];
        nftAvailable += reward.nft;
        localStorage.setItem('quantumNftCount', nftAvailable);
        
        showNotification(reward.message, 'success');
        playSound('gift');
    }
}

// Проверка нового ранга
function checkNewRank() {
    const newRank = ranks.find(rank => userLevel >= rank.minLevel) || ranks[0];
    
    if (newRank.name !== userRank) {
        userRank = newRank.name;
        localStorage.setItem('quantumUserRank', userRank);
        
        showNotification(`🎖️ Новый ранг: ${userRank}`, 'success');
    }
}

// Сохранение данных уровня
function saveLevelData() {
    localStorage.setItem('quantumUserLevel', userLevel);
    localStorage.setItem('quantumUserXP', userXP);
}

// Обновление отображения уровня
function updateLevelDisplay() {
    let levelBadge = document.getElementById('levelBadge');
    
    if (!levelBadge) {
        levelBadge = document.createElement('div');
        levelBadge.id = 'levelBadge';
        levelBadge.className = 'level-badge';
        document.querySelector('.user-name').appendChild(levelBadge);
    }
    
    const xpNeeded = calculateXPNeeded(userLevel);
    const progress = (userXP / xpNeeded) * 100;
    const currentRank = ranks.find(rank => userLevel >= rank.minLevel) || ranks[0];
    
    levelBadge.innerHTML = `
        <span class="rank-badge" style="background: ${currentRank.color}">${userRank}</span>
        <span class="level-text">Ур. ${userLevel}</span>
        <div class="xp-bar">
            <div class="xp-progress" style="width: ${progress}%"></div>
        </div>
        <span class="xp-text">${userXP}/${xpNeeded} XP</span>
    `;
}

// Показ информации об уровне
function showLevelInfo() {
    const xpNeeded = calculateXPNeeded(userLevel);
    const progress = (userXP / xpNeeded) * 100;
    const nextRank = ranks.find(rank => userLevel < rank.minLevel);
    
    let info = `🎯 Твой уровень: ${userLevel}\n`;
    info += `⭐ Опыт: ${userXP}/${xpNeeded} (${progress.toFixed(1)}%)\n`;
    info += `🎖️ Ранг: ${userRank}\n\n`;
    info += `📊 До следующего уровня: ${xpNeeded - userXP} XP\n`;
    
    if (nextRank) {
        info += `🏆 До ранга "${nextRank.name}": ${nextRank.minLevel - userLevel} уровней`;
    }
    
    alert(info);
}

// Добавляем XP за разные действия
function setupXPSystem() {
    // За сообщение
    addXP(5);
    
    // За подарок
    addXP(10, 'подарок');
    
    // За голосовое сообщение
    addXP(15, 'голосовое сообщение');
    
    // За реакцию
    addXP(2, 'реакция');
}

// Стили для системы уровней
const levelStyles = `
    .level-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        margin-left: 10px;
    }
    
    .rank-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: bold;
        font-size: 10px;
    }
    
    .xp-bar {
        width: 60px;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        overflow: hidden;
    }
    
    .xp-progress {
        height: 100%;
        background: linear-gradient(90deg, #00b894, #00cec9);
        transition: width 0.5s ease;
    }
    
    .xp-text {
        font-size: 10px;
        opacity: 0.8;
    }
    
    .level-up-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: white;
        padding: 20px;
        border-radius: 15px;
        z-index: 10000;
        animation: levelUpAnimation 0.5s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    
    .level-up-content {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .level-up-icon {
        font-size: 40px;
        animation: bounce 1s infinite;
    }
    
    .level-up-text h3 {
        margin: 0;
        font-size: 18px;
    }
    
    .new-level {
        font-size: 24px;
        font-weight: bold;
        color: #ffeaa7;
    }
    
    .level-up-confetti {
        font-size: 24px;
        animation: spin 1s ease;
    }
    
    @keyframes levelUpAnimation {
        0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;

// Добавляем стили
const levelStyleSheet = document.createElement('style');
levelStyleSheet.textContent = levelStyles;
document.head.appendChild(levelStyleSheet);

// Команда для проверки уровня
function showLevelCommand() {
    showLevelInfo();
}

// Добавляем в команды
function handleCommands(text) {
    const command = text.toLowerCase().trim();
    
    if (command === '/level') {
        showLevelInfo();
        return true;
    }
    
    if (command === '/rank') {
        showLevelInfo();
        return true;
    }
    
    // ... остальные команды
    return false;
}

// Запускаем систему при загрузке
setTimeout(() => {
    updateLevelDisplay();
    showNotification(`Добро пожаловать назад, ${userRank} ${currentUser}!`, 'success');
}, 2000);

// ★★★★ КОНЕЦ СИСТЕМЫ УРОВНЕЙ ★★★★
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
    // ★★★★ 30 НОВЫХ ФУНКЦИЙ ДЛЯ QUANTUM MESSENGER ★★★★
    // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

    // 1. СИСТЕМА РЕЙТИНГА (исправленная и улучшенная)
    function rateUser(userId, rating, comment = '') {
        if (!userId || !currentUser) return;
        
        const ratingData = {
            fromUser: currentUser,
            fromUserId: userId,
            rating: rating,
            comment: comment,
            timestamp: Date.now()
        };
        
        database.ref(`userRatings/${userId}`).push(ratingData, (error) => {
            if (error) {
                console.error("Ошибка оценки:", error);
                showNotification("Ошибка при отправке оценки");
            } else {
                showNotification("Спасибо за вашу оценку! ★");
                // Обновляем рейтинг в профиле
                updateUserRating(userId);
            }
        });
    }

    function updateUserRating(userId) {
        database.ref(`userRatings/${userId}`).once('value').then(snapshot => {
            if (!snapshot.exists()) return;
            
            const ratings = snapshot.val();
            let total = 0;
            let count = 0;
            
            for (const key in ratings) {
                total += ratings[key].rating;
                count++;
            }
            
            const average = total / count;
            // Сохраняем средний рейтинг в профиле пользователя
            database.ref(`profiles/${userId}`).update({
                rating: average.toFixed(1),
                ratingCount: count
            });
        });
    }

    function showUserRating(userId) {
        database.ref(`profiles/${userId}/rating`).once('value').then(snapshot => {
            const rating = snapshot.val() || "нет оценок";
            const ratingCount = snapshot.val() ? database.ref(`profiles/${userId}/ratingCount`).once('value') : 0;
            
            showNotification(`⭐ Рейтинг пользователя: ${rating}/5 (на основе ${ratingCount} оценок)`);
        });
    }

    // 2. СИСТЕМА ЗВЕЗДОЧЕК ДЛЯ СООБЩЕНИЙ
    function rateMessage(messageId, rating) {
        if (!currentUser) return;
        
        database.ref(`messageRatings/${messageId}/${userId}`).set({
            rating: rating,
            timestamp: Date.now()
        });
        
        showNotification("Вы оценили сообщение ★");
    }

    // 3. СИСТЕМА ЖАЛОБ
    function reportContent(type, id, reason) {
        const reportData = {
            type: type, // 'user' или 'message'
            reportedId: id,
            reporter: currentUser,
            reason: reason,
            timestamp: Date.now()
        };
        
        database.ref('reports').push(reportData);
        showNotification("Жалоба отправлена администраторам. Спасибо!");
    }

    // 4. СИСТЕМА ПРЕМИУМ-ПОДПИСКИ
    function activatePremium() {
        const premiumData = {
            activated: Date.now(),
            expires: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 дней
            features: ['цветные сообщения', 'анимированные смайлики', 'особые значки']
        };
        
        database.ref(`premiumUsers/${userId}`).set(premiumData);
        showNotification("🎉 Премиум-подписка активирована на 30 дней!");
    }

    // 5. СИСТЕМА ДРУЗЕЙ
    function addFriend(friendId) {
        database.ref(`friends/${userId}/${friendId}`).set({
            since: Date.now(),
            status: 'pending'
        });
        
        database.ref(`friends/${friendId}/${userId}`).set({
            since: Date.now(),
            status: 'request'
        });
        
        showNotification("Запрос на дружбу отправлен!");
    }

    // 6. ЧЕРНЫЙ СПИСОК
    function blockUser(userIdToBlock) {
        database.ref(`blockedUsers/${userId}/${userIdToBlock}`).set({
            blockedAt: Date.now(),
            reason: 'пользователь заблокирован'
        });
        
        showNotification("Пользователь заблокирован. Вы больше не увидите его сообщения.");
    }

    // 7. СИСТЕМА ПЕРЕВОДА (игровая валюта)
    function sendCoins(toUserId, amount) {
        if (amount <= 0) return;
        
        // Проверяем баланс
        database.ref(`userCoins/${userId}`).once('value').then(snapshot => {
            const currentCoins = snapshot.val() || 0;
            
            if (currentCoins >= amount) {
                // Списание
                database.ref(`userCoins/${userId}`).set(currentCoins - amount);
                // Зачисление
                database.ref(`userCoins/${toUserId}`).transaction(coins => (coins || 0) + amount);
                
                showNotification(`Вы отправили ${amount} монет пользователю`);
            } else {
                showNotification("Недостаточно монет для перевода");
            }
        });
    }

    // 8. ЕЖЕДНЕВНАЯ НАГРАДА
    function claimDailyReward() {
        const today = new Date().toDateString();
        const lastClaim = localStorage.getItem('lastDailyClaim');
        
        if (lastClaim === today) {
            showNotification("Вы уже получали награду сегодня. Приходите завтра!");
            return;
        }
        
        const reward = Math.floor(Math.random() * 50) + 10; // 10-60 монет
        database.ref(`userCoins/${userId}`).transaction(coins => (coins || 0) + reward);
        
        localStorage.setItem('lastDailyClaim', today);
        showNotification(`🎁 Ежедневная награда: ${reward} монет!`);
    }

    // 9. МИНИ-ИГРА "ОРЁЛ И РЕШКА"
    function flipCoin() {
        const result = Math.random() > 0.5 ? "орёл" : "решка";
        const bet = 5; // Ставка 5 монет
        
        database.ref(`userCoins/${userId}`).once('value').then(snapshot => {
            const coins = snapshot.val() || 0;
            
            if (coins < bet) {
                showNotification("Недостаточно монет для игры");
                return;
            }
            
            if (result === "орёл") {
                // Выигрыш
                database.ref(`userCoins/${userId}`).set(coins + bet);
                showNotification(`🎉 Вы выиграли! Выпал: ${result}. +${bet} монет`);
            } else {
                // Проигрыш
                database.ref(`userCoins/${userId}`).set(coins - bet);
                showNotification(`😢 Вы проиграли. Выпал: ${result}. -${bet} монет`);
            }
        });
    }

    // 10. СИСТЕМА СТАТУСОВ (онлайн, занят, не беспокоить)
    function setUserStatus(status) {
        database.ref(`profiles/${userId}/status`).set(status);
        showNotification(`Статус изменен на: ${status}`);
    }

    // 11. НАПОМИНАНИЯ
    function setReminder(time, message) {
        const reminderId = 'reminder_' + Date.now();
        const reminderData = {
            time: time,
            message: message,
            createdAt: Date.now()
        };
        
        localStorage.setItem(reminderId, JSON.stringify(reminderData));
        showNotification(`Напоминание установлено на ${new Date(time).toLocaleTimeString()}`);
        
        // Запускаем таймер
        const now = new Date().getTime();
        const delay = time - now;
        
        if (delay > 0) {
            setTimeout(() => {
                showNotification(`🔔 Напоминание: ${message}`);
            }, delay);
        }
    }

    // 12. ПОИСК ПОЛЬЗОВАТЕЛЕЙ
    function searchUsers(query) {
        database.ref('profiles').once('value').then(snapshot => {
            if (!snapshot.exists()) return;
            
            const users = snapshot.val();
            const results = [];
            
            for (const id in users) {
                if (users[id].name && users[id].name.toLowerCase().includes(query.toLowerCase())) {
                    results.push({id, ...users[id]});
                }
            }
            
            if (results.length > 0) {
                showNotification(`Найдено пользователей: ${results.length}`);
                // Здесь можно показать результаты в специальном окне
            } else {
                showNotification("Пользователи не найдены");
            }
        });
    }

    // 13. ЭФФЕКТЫ ДЛЯ СООБЩЕНИЙ (только для премиум)
    function sendMessageWithEffect(message, effect) {
        if (!currentUser) return;
        
        const messageData = {
            text: encryptMessage(message),
            name: currentUser,
            userId: userId,
            timestamp: Date.now(),
            effect: effect, // 'fireworks', 'confetti', 'rainbow'
            isDeveloper: isDeveloper,
            isTester: isTester
        };
        
        database.ref('messages').push(messageData);
        showNotification("Сообщение с эффектом отправлено!");
    }

    // 14. АНОНИМНЫЕ СООБЩЕНИЯ
    function sendAnonymousMessage(message, recipientId = null) {
        const messageData = {
            text: encryptMessage(message),
            name: "Аноним",
            userId: "anonymous",
            timestamp: Date.now(),
            anonymous: true,
            recipientId: recipientId
        };
        
        database.ref('messages').push(messageData);
        showNotification("Анонимное сообщение отправлено");
    }

    // 15. ЦИТАТЫ ДНЯ
    function getDailyQuote() {
        const quotes = [
            "Общение — это искусство понимания.",
            "Лучший способ начать день — улыбнуться кому-то.",
            "В каждом сообщении есть частичка души отправителя."
        ];
        
        const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
        sendMessage(randomQuote);
    }

    // 16. СЛУЧАЙНЫЙ ФАКТ
    function sendRandomFact() {
        const facts = [
            "Знаете ли вы, что первое сообщение было отправлено в 1969 году?",
            "Самый популярный смайлик в мире — 😂",
            "За день в мире отправляется более 300 миллиардов сообщений!"
        ];
        
        const randomFact = facts[Math.floor(Math.random() * facts.length)];
        sendMessage(randomFact);
    }

    // 17. КАЛЬКУЛЯТОР В ЧАТЕ
    function calculateInChat(expression) {
        try {
            // Безопасное вычисление
            const result = Function('"use strict"; return (' + expression + ')')();
            sendMessage(`${expression} = ${result}`);
        } catch (error) {
            showNotification("Не могу вычислить это выражение");
        }
    }

    // 18. ПОГОДА ПО ЗАПРОСУ
    function getWeather(city) {
        // В реальном приложении здесь был бы запрос к API погоды
        const fakeWeather = {
            "москва": "☀️ +20°C, солнечно",
            "санкт-петербург": "🌧️ +15°C, дождь",
            "сочи": "🌤️ +25°C, тепло"
        };
        
        const weather = fakeWeather[city.toLowerCase()] || "Не знаю погоду для этого города";
        sendMessage(`Погода в ${city}: ${weather}`);
    }

    // 19. СЛУЧАЙНАЯ ШУТКА
    function tellJoke() {
        const jokes = [
            "Почему программисты путают Хэллоуин и Рождество? Потому что Oct 31 = Dec 25!",
            "Как называют security-специалиста в России? Хакерман!",
            "Почему чат-бот пошел к врачу? Потому что у него был вирус!"
        ];
        
        const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
        sendMessage(randomJoke);
    }

    // 20. ТАЙМЕР ОБРАТНОГО ОТСЧЕТА
    function startCountdown(seconds, title) {
        const countdownData = {
            seconds: seconds,
            title: title || "Обратный отсчет",
            startedBy: currentUser,
            startTime: Date.now()
        };
        
        database.ref('countdowns').set(countdownData);
        showNotification(`Обратный отсчет начат: ${title}`);
        
        // Обновляем каждую секунду
        const countdownInterval = setInterval(() => {
            countdownData.seconds--;
            
            if (countdownData.seconds <= 0) {
                clearInterval(countdownInterval);
                database.ref('messages').push({
                    text: `⏰ Обратный отсчет завершен: ${title}`,
                    name: "Система",
                    timestamp: Date.now(),
                    isSystem: true
                });
                database.ref('countdowns').remove();
            } else {
                database.ref('countdowns').set(countdownData);
            }
        }, 1000);
    }

    // 21. ВИКТОРИНА
    function startQuiz(question, options, correctIndex) {
        const quizData = {
            question: question,
            options: options,
            correctIndex: correctIndex,
            active: true,
            startedBy: currentUser
        };
        
        database.ref('currentQuiz').set(quizData);
        showNotification("Викторина началась! Ответьте в чате номером правильного варианта");
    }

    // 22. ОПРОСЫ (улучшенные)
    function createPoll(question, options, duration = 24) {
        const pollData = {
            question: question,
            options: options.reduce((acc, option, index) => {
                acc[index] = { text: option, votes: 0 };
                return acc;
            }, {}),
            createdBy: currentUser,
            createdAt: Date.now(),
            expiresAt: Date.now() + (duration * 60 * 60 * 1000)
        };
        
        database.ref('polls').push(pollData);
        showNotification("Опрос создан!");
    }

    // 23. СИСТЕМА ПРЕДСКАЗАНИЙ
    function getPrediction() {
        const predictions = [
            "Сегодня вас ждет приятное сообщение",
            "Кто-то скоро отправит вам подарок",
            "Вас ждет интересное знакомство в чате"
        ];
        
        const randomPrediction = predictions[Math.floor(Math.random() * predictions.length)];
        sendMessage(`🔮 Предсказание: ${randomPrediction}`);
    }

    // 24. КОНВЕРТЕР ВАЛЮТ
    function convertCurrency(amount, from, to) {
        // Упрощенный конвертер (в реальном приложении - API)
        const rates = {
            USD: { RUB: 90, EUR: 0.85 },
            EUR: { RUB: 100, USD: 1.18 },
            RUB: { USD: 0.011, EUR: 0.01 }
        };
        
        if (rates[from] && rates[from][to]) {
            const result = amount * rates[from][to];
            sendMessage(`${amount} ${from} = ${result.toFixed(2)} ${to}`);
        } else {
            showNotification("Не могу конвертировать эти валюты");
        }
    }

    // 25. СЛУЧАЙНЫЙ ВЫБОР
    function makeChoice(options) {
        const optionsArray = options.split(' или ');
        const randomChoice = optionsArray[Math.floor(Math.random() * optionsArray.length)];
        sendMessage(`Я выбираю: ${randomChoice.trim()}!`);
    }

    // 26. ДНЕВНИК НАСТРОЕНИЯ
    function logMood(mood, note = "") {
        const moodData = {
            mood: mood, // 'happy', 'sad', 'excited'
            note: note,
            date: new Date().toDateString()
        };
        
        database.ref(`moodDiary/${userId}`).push(moodData);
        showNotification("Настроение сохранено в дневник 📔");
    }

    // 27. СИСТЕМА НАПОМИНАНИЯ О ДНЕ РОЖДЕНИЯ
    function addBirthday(date, person) {
        const birthdayData = {
            date: date,
            person: person,
            notified: false
        };
        
        localStorage.setItem(`birthday_${person}`, JSON.stringify(birthdayData));
        showNotification(`День рождения ${person} добавлен в напоминания`);
    }

    // 28. МУЗЫКАЛЬНЫЕ РЕКОМЕНДАЦИИ
    function getMusicRecommendation(genre) {
        const recommendations = {
            pop: ["Artist1 - Song1", "Artist2 - Song2"],
            rock: ["Artist3 - Song3", "Artist4 - Song4"],
            jazz: ["Artist5 - Song5", "Artist6 - Song6"]
        };
        
        const songs = recommendations[genre] || ["Исполнитель - Композиция"];
        const randomSong = songs[Math.floor(Math.random() * songs.length)];
        sendMessage(`🎵 Рекомендую послушать: ${randomSong}`);
    }

    // 29. СИСТЕМА ОБМЕНА КНИГАМИ
    function shareBook(bookTitle, author, comment = "") {
        const bookData = {
            title: bookTitle,
            author: author,
            comment: comment,
            sharedBy: currentUser,
            sharedAt: Date.now()
        };
        
        database.ref('sharedBooks').push(bookData);
        showNotification("Книга добавлена в общую библиотеку 📚");
    }

    // 30. ВИРТУАЛЬНЫЕ РАСТЕНИЯ (тамагочи)
    function createVirtualPlant(plantName) {
        const plantData = {
            name: plantName,
            created: Date.now(),
            lastWatered: Date.now(),
            health: 100,
            growth: 0
        };
        
        localStorage.setItem(`plant_${plantName}`, JSON.stringify(plantData));
        showNotification(`🌱 Вы создали виртуальное растение "${plantName}". Поливайте его каждый день!`);
    }

    function waterPlant(plantName) {
        const plantData = JSON.parse(localStorage.getItem(`plant_${plantName}`) || '{}');
        
        if (plantData.name) {
            const now = Date.now();
            const hoursSinceWater = (now - plantData.lastWatered) / (1000 * 60 * 60);
            
            if (hoursSinceWater < 24) {
                showNotification("Растение еще не хочет пить");
            } else {
                plantData.lastWatered = now;
                plantData.health = Math.min(100, plantData.health + 10);
                plantData.growth += 5;
                
                localStorage.setItem(`plant_${plantName}`, JSON.stringify(plantData));
                showNotification(`Вы полили ${plantName}. Рост: ${plantData.growth}%`);
            }
        } else {
            showNotification("Сначала создайте растение командой /растение");
        }
    }

    // ★★★★★ ОБРАБОТКА КОМАНД ★★★★★
    function handleCommands(text) {
        const command = text.toLowerCase().trim();
        
        // Обработка новых команд
        if (command === '/оценка' && currentProfileView) {
            showRatingDialog(currentProfileView);
            return true;
        }
        
        if (command === '/рейтинг' && currentProfileView) {
            showUserRating(currentProfileView);
            return true;
        }
        
        if (command === '/монеты') {
            database.ref(`userCoins/${userId}`).once('value').then(snapshot => {
                const coins = snapshot.val() || 0;
                showNotification(`У вас ${coins} монет`);
            });
            return true;
        }
        
        if (command === '/ежедневно') {
            claimDailyReward();
            return true;
        }
        
        if (command === '/монетка') {
            flipCoin();
            return true;
        }
        
        if (command === '/шутка') {
            tellJoke();
            return true;
        }
        
        if (command === '/факт') {
            sendRandomFact();
            return true;
        }
        
        if (command === '/предсказание') {
            getPrediction();
            return true;
        }
        
        if (command === '/цитата') {
            getDailyQuote();
            return true;
        }
        
        if (command.startsWith('/погода')) {
            const city = command.replace('/погода', '').trim();
            if (city) {
                getWeather(city);
            } else {
                showNotification("Укажите город: /погода Москва");
            }
            return true;
        }
        
        if (command.startsWith('/выбери')) {
            const options = command.replace('/выбери', '').trim();
            if (options) {
                makeChoice(options);
            } else {
                showNotification("Укажите варианты: /выбери пицца или суши");
            }
            return true;
        }
        
        if (command.startsWith('/конверт')) {
            const parts = command.replace('/конверт', '').trim().split(' ');
            if (parts.length === 3) {
                const amount = parseFloat(parts[0]);
                const from = parts[1].toUpperCase();
                const to = parts[2].toUpperCase();
                
                if (!isNaN(amount)) {
                    convertCurrency(amount, from, to);
                } else {
                    showNotification("Использование: /конверт 100 USD RUB");
                }
            } else {
                showNotification("Использование: /конверт [сумма] [из] [в]");
            }
            return true;
        }
        
        if (command.startsWith('/напомни')) {
            const parts = command.replace('/напомни', '').trim().split(' в ');
            if (parts.length === 2) {
                const message = parts[0];
                const timeStr = parts[1];
                
                // Простой парсинг времени (например: "15:30")
                const [hours, minutes] = timeStr.split(':').map(Number);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    const now = new Date();
                    const reminderTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                    
                    if (reminderTime > now) {
                        setReminder(reminderTime.getTime(), message);
                    } else {
                        showNotification("Укажите время в будущем");
                    }
                } else {
                    showNotification("Использование: /напомни позвать всех в 15:30");
                }
            } else {
                showNotification("Использование: /напомни [сообщение] в [время]");
            }
            return true;
        }
        
        if (command === '/уровень') {
            showLevelInfo();
            return true;
        }
        
        if (command === '/ранг') {
            showLevelInfo();
            return true;
        }
        
        // Добавьте здесь обработку других команд...
        
        return false;
    }

    // ★★★★★ ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ИНТЕРФЕЙСА ★★★★★
    
    function showRatingDialog(userId) {
        const rating = prompt("Оцените пользователя от 1 до 5 звезд:");
        if (rating && rating >= 1 && rating <= 5) {
            const comment = prompt("Оставьте комментарий (не обязательно):");
            rateUser(userId, parseInt(rating), comment || "");
        }
    }

    // Обновляем функцию отправки сообщения для обработки команд
    const originalSendMessage = sendMessage;
    sendMessage = function() {
        const messageText = messageInput.value.trim();
        
        // Проверяем, является ли сообщение командой
        if (messageText.startsWith('/')) {
            if (handleCommands(messageText)) {
                messageInput.value = '';
                sendBtn.disabled = true;
                return;
            }
        }
        
        // Если не команда, отправляем обычное сообщение
        originalSendMessage();
    };

    // ★★★★★ ИНИЦИАЛИЗАЦИЯ НОВЫХ ФУНКЦИЙ ПРИ ЗАГРУЗКЕ ★★★★★
    window.addEventListener('load', () => {
        // Загружаем монеты пользователя
        database.ref(`userCoins/${userId}`).once('value').then(snapshot => {
            if (!snapshot.exists()) {
                database.ref(`userCoins/${userId}`).set(100); // Начальные монеты
            }
        });
        
        // Проверяем ежедневную награду
        setTimeout(() => {
            const today = new Date().toDateString();
            const lastClaim = localStorage.getItem('lastDailyClaim');
            
            if (lastClaim !== today) {
                showNotification("Не забудьте получить ежедневную награду командой /ежедневно");
            }
        }, 10000);
    });
    // Ждем, когда вся страница загрузится
document.addEventListener('DOMContentLoaded', function() {
    // Получаем элементы для работы с темами
    const themeMenuToggle = document.getElementById('themeMenuToggle');
    const themeModal = document.getElementById('themeModal');
    const closeThemeBtn = document.getElementById('closeThemeBtn');
    const themeOptions = document.querySelectorAll('.theme-option');
    // Предпросмотр темы при наведении
themeOptions.forEach(option => {
    option.addEventListener('mouseenter', () => {
        const theme = option.getAttribute('data-theme');
        document.body.classList.add('theme-preview');
        if (theme !== 'default') {
            document.body.classList.add(theme);
        }
    });
    
    option.addEventListener('mouseleave', () => {
        const currentTheme = localStorage.getItem('quantumTheme') || 'default';
        document.body.classList.remove('theme-preview');
        document.body.classList.remove('light-theme', 'sea-theme', 'halloween-theme', 'christmas-theme');
        if (currentTheme !== 'default') {
            document.body.classList.add(currentTheme);
        }
    });
});
    
    // Проверяем, существуют ли элементы перед работой с ними
    if (themeMenuToggle && themeModal && closeThemeBtn) {
        // Открытие меню тем
        themeMenuToggle.addEventListener('click', () => {
            themeModal.classList.add('active');
        });

        // Закрытие меню тем
        closeThemeBtn.addEventListener('click', () => {
            themeModal.classList.remove('active');
        });

        // Смена темы
        themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.getAttribute('data-theme');
                
                // Убираем все классы тем
                document.body.classList.remove('light-theme', 'sea-theme', 'halloween-theme', 'christmas-theme');
                
                // Добавляем выбранную тему (кроме default)
                if (theme !== 'default') {
                    document.body.classList.add(theme);
                }
                
                // Сохраняем выбор в память
                localStorage.setItem('quantumTheme', theme);
                
                // Закрываем меню
                themeModal.classList.remove('active');
                
                showNotification(`Тема изменена!`);
            });
        });
    }
});
// Функция показа меню статусов
function showStatusMenu() {
    document.getElementById('statusModal').classList.add('active');
}

// Функция установки статуса
function setUserStatus(status) {
    if (!userId) return;
    
    // Сохраняем статус в базу данных
    database.ref('profiles/' + userId).update({
        status: status,
        lastStatusChange: Date.now()
    });
    
    // Показываем уведомление
    const statusNames = {
        'online': 'Онлайн',
        'away': 'Отошёл', 
        'busy': 'Занят',
        'dnd': 'Не беспокоить'
    };
    showNotification(`Статус изменен на: ${statusNames[status]}`);
    
    // Закрываем меню
    document.getElementById('statusModal').classList.remove('active');
}
// Функция для добавления анимации к смайликам
function addEmojiAnimations() {
    // Словарь анимаций для разных смайликов
    const emojiAnimations = {
        '👋': 'wave',
        '🎉': 'spin',
        '⚽': 'bounce',
        '❤️': 'heartbeat',
        '✨': 'pulse',
        '🔥': 'pulse',
        '⭐': 'spin',
        '🎈': 'bounce',
        '🎁': 'pulse',
        '🏆': 'spin',
        '😂': 'bounce',
        '😍': 'heartbeat',
        '🤩': 'pulse',
        '😎': 'spin',
        '🥳': 'wave'
    };
    
    // Находим все сообщения
    const messages = document.querySelectorAll('.message');
    
    messages.forEach(message => {
        // Ищем смайлики в тексте сообщения
        const emojis = message.innerHTML.match(/[\p{Emoji}]/gu) || [];
        
        emojis.forEach(emoji => {
            if (emojiAnimations[emoji]) {
                const animation = emojiAnimations[emoji];
                // Заменяем обычный смайлик на анимированный
                message.innerHTML = message.innerHTML.replace(
                    emoji, 
                    `<span class="emoji-animated ${animation}">${emoji}</span>`
                );
            }
        });
    });
}

// Вызываем функцию при загрузке сообщений и при добавлении новых
setInterval(addEmojiAnimations, 500);
// ФУНКЦИОНАЛ ВКЛАДОК ЧАТА
function setupChatTabs() {
    const tabs = document.querySelectorAll('.chat-tab');
    const messagesWrapper = document.getElementById('messagesContainer');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Убираем активный класс у всех вкладок
            tabs.forEach(t => t.classList.remove('active'));
            // Добавляем активный класс к выбранной вкладке
            tab.classList.add('active');
            
            const tabType = tab.getAttribute('data-tab');
            
            if (tabType === 'general') {
                // Переключаемся на общий чат
                exitPrivateChat();
            } else if (tabType === 'private') {
                // Переключаемся на список приватных чатов
                showPrivateChatsList();
            }
        });
    });
}

// ПОКАЗЫВАЕМ СПИСОК ПРИВАТНЫХ ЧАТОВ
function showPrivateChatsList() {
    const messagesWrapper = document.getElementById('messagesContainer');
    messagesWrapper.innerHTML = `
        <div class="private-chats-list">
            <h3>Мои приватные чаты</h3>
            <div class="private-chats-container" id="privateChatsContainer">
                <div class="loading">
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            </div>
            <p>Выбери чат или начни новый через профиль пользователя</p>
        </div>
    `;
    
    loadPrivateChatsList();
}

// ЗАГРУЖАЕМ СПИСОК РЕАЛЬНЫХ ПРИВАТНЫХ ЧАТОВ
function loadPrivateChatsList() {
    const container = document.getElementById('privateChatsContainer');
    container.innerHTML = '<div class="loading"><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div>';
    
    // Загружаем приватные чаты из базы данных
    database.ref('privateChats/' + userId).once('value').then((snapshot) => {
        container.innerHTML = '';
        
        if (!snapshot.exists()) {
            container.innerHTML = '<div class="empty-chat"><i class="fas fa-comments"></i><p>У вас пока нет приватных чатов</p></div>';
            return;
        }
        
        const chats = snapshot.val();
        Object.keys(chats).forEach(chatUserId => {
            const chat = chats[chatUserId];
            
            const chatItem = document.createElement('div');
            chatItem.classList.add('private-chat-item');
            
            // Форматируем время последней активности
            const lastActive = new Date(chat.lastActivity);
            const timeDiff = Math.floor((Date.now() - chat.lastActivity) / (1000 * 60));
            let timeText = '';
            
            if (timeDiff < 1) timeText = 'только что';
            else if (timeDiff < 60) timeText = `${timeDiff} мин назад`;
            else if (timeDiff < 1440) timeText = `${Math.floor(timeDiff / 60)} ч назад`;
            else timeText = lastActive.toLocaleDateString();
            
            chatItem.innerHTML = `
                <div class="private-chat-avatar">${chat.userName.charAt(0).toUpperCase()}</div>
                <div class="private-chat-info">
                    <div class="private-chat-name">${chat.userName}</div>
                    <div class="private-chat-lastmsg">${chat.lastMessage || 'Нет сообщений'}</div>
                    <div class="private-chat-time">${timeText}</div>
                </div>
                <button class="action-btn" onclick="enterPrivateChat('${chat.userId}', '${chat.userName}')">
                    Открыть
                </button>
            `;
            
            container.appendChild(chatItem);
        });
    }).catch((error) => {
        console.error("Ошибка загрузки чатов:", error);
        container.innerHTML = '<div class="empty-chat"><i class="fas fa-exclamation-triangle"></i><p>Ошибка загрузки чатов</p></div>';
    });
}

// ДОБАВИМ СТИЛИ ДЛЯ СПИСКА ЧАТОВ
const privateChatsStyles = `
.private-chats-list {
    padding: 20px;
    text-align: center;
}

.private-chats-list h3 {
    margin-bottom: 15px;
    color: var(--text-color);
}

.private-chat-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin: 10px 0;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.private-chat-item:hover {
    background: rgba(255, 255, 255, 0.2);
}

.private-chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(to right, #4facfe, #00f2fe);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-right: 12px;
}

.private-chat-info {
    flex: 1;
    text-align: left;
}

.private-chat-name {
    font-weight: bold;
    margin-bottom: 4px;
}

.private-chat-lastmsg {
    font-size: 12px;
    opacity: 0.8;
}
`;

// Добавляем стили в страницу
const styleSheet = document.createElement('style');
styleSheet.textContent = privateChatsStyles;
document.head.appendChild(styleSheet);

// ВЫЗЫВАЕМ ФУНКЦИЮ ПРИ ЗАГРУЗКЕ
// Найди в коде строку: window.addEventListener('load', () => {
// И внутри этой функции, в самом конце, добавь:
setupChatTabs();
// Функция для выхода из приватного чата
function exitPrivateChat() {
// Останавливаем все слушатели приватных сообщений
Object.values(privateMessagesListeners).forEach(listener => {
    if (listener) listener();
});
privateMessagesListeners = {};
    isPrivateChatActive = false;
    privateChatWithUserId = null;
    privateChatWithUserName = '';
    
    // Скрываем индикатор приватного чата
    document.getElementById('chatModeIndicator').style.display = 'none';
    
    // Восстанавливаем обычный заголовок
    document.querySelector('.chat-header .user-name span').textContent = currentUser;
    
    // Переключаемся на общий чат
    document.querySelectorAll('.chat-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector('.chat-tab[data-tab="general"]').classList.add('active');
    
    // Очищаем сообщения и загружаем общие
    messagesContainer.innerHTML = '';
    removeAllListeners();
    loadMessages();
    setupOnlineUsers();
    setupTypingIndicator();
    
    showNotification("Вы вышли из приватного чата");
}
// Найди элементы настроек
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettingsBtn = document.getElementById('closeSettingsBtn');

// Добавь обработчики событий
if (settingsBtn && settingsModal && closeSettingsBtn) {
    settingsBtn.addEventListener('click', () => {
        settingsModal.classList.add('active');
    });
    
    closeSettingsBtn.addEventListener('click', () => {
        settingsModal.classList.remove('active');
    });
    
    // Закрытие при клике вне окна
    settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) {
            settingsModal.classList.remove('active');
        }
    });
}

// Функция для показа статистики
function showLevelInfo() {
    const xpNeeded = calculateXPNeeded(userLevel);
    const progress = (userXP / xpNeeded) * 100;
    const currentRank = ranks.find(rank => userLevel >= rank.minLevel) || ranks[0];
    const nextRank = ranks.find(rank => userLevel < rank.minLevel);
    
    let info = `🎯 Уровень: ${userLevel}\n`;
    info += `⭐ Опыт: ${userXP}/${xpNeeded} (${progress.toFixed(1)}%)\n`;
    info += `🎖️ Ранг: ${currentRank.name}\n`;
    info += `🏆 NFT: ${nftAvailable} доступно\n\n`;
    
    if (nextRank) {
        info += `📈 До следующего ранга "${nextRank.name}": ${nextRank.minLevel - userLevel} уровней`;
    }
    
    alert(info);
}
// Функция для открытия окна создания опроса
function createPollModal() {
    document.getElementById('pollModal').classList.add('active');
}

// Обработчики для модального окна опроса
document.getElementById('addPollOptionBtn').addEventListener('click', function() {
    const optionsContainer = document.getElementById('pollOptions');
    const newOption = document.createElement('input');
    newOption.type = 'text';
    newOption.className = 'poll-option-input';
    newOption.placeholder = 'Вариант ' + (optionsContainer.children.length + 1);
    optionsContainer.appendChild(newOption);
});

document.getElementById('createPollBtn').addEventListener('click', function() {
    const question = document.getElementById('pollQuestion').value;
    const options = [];
    
    document.querySelectorAll('.poll-option-input').forEach(input => {
        if (input.value.trim() !== '') {
            options.push(input.value.trim());
        }
    });
    
    if (question && options.length >= 2) {
        createPoll(question, options);
        document.getElementById('pollModal').classList.remove('active');
        // Очищаем поля после создания
        document.getElementById('pollQuestion').value = '';
        document.querySelectorAll('.poll-option-input').forEach(input => input.value = '');
    } else {
        alert('Добавьте вопрос и хотя бы 2 варианта ответа!');
    }
});

document.getElementById('closePollBtn').addEventListener('click', function() {
    document.getElementById('pollModal').classList.remove('active');
});

// Функция создания опроса (уже есть в твоём коде, но проверь её)
function createPoll(question, options) {
    // Этот код уже есть в твоём коде в разделе "22. ОПРОСЫ"
    const pollData = {
        question: question,
        options: options.reduce((acc, option, index) => {
            acc[index] = { text: option, votes: 0 };
            return acc;
        }, {}),
        createdBy: currentUser,
        createdAt: Date.now(),
        expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 часа
    };
    
    database.ref('polls').push(pollData);
    showNotification("Опрос создан!");
}
// ★★★ ФУНКЦИЯ ПЕРЕВОДА СООБЩЕНИЙ ★★★
async function translateMessage(messageId, buttonElement) {
    // 1. Находим само сообщение по его ID
    const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
    if (!messageElement) return;

    // 2. Находим текст сообщения. Он находится в основном элементе, но не в цитате и не в других частях.
    // Простой способ: ищем элемент, который непосредственно содержит текст.
    let textToTranslate = messageElement.textContent; // Берём весь текст из сообщения

    // 3. Убираем лишнее: время, имя отправителя, текст цитаты
    // Это сложная часть, потому что структура сообщения большая.
    // Простой способ: перевести весь текст, а потом вручную убрать лишнее
    // Лучший способ: помечать текст для перевода специальным классом, но это сложнее.

    // 4. Покажем пользователю, что идёт процесс (меняем иконку на спиннер)
    const originalIcon = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    try {
        // 5. Используем бесплатный API переводчика (например, Libretranslate)
        // ВАЖНО: Этот API может не всегда работать, так как он бесплатный и общедоступный.
        const response = await fetch('https://libretranslate.de/translate', {
            method: 'POST',
            body: JSON.stringify({
                q: textToTranslate,
                source: 'auto', // автоматическое определение языка
                target: 'ru',   // переводим на русский
                format: 'text'
            }),
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.translatedText) {
            // 6. Создаём красивый блок с переводом
            const translationDiv = document.createElement('div');
            translationDiv.className = 'message-translation';
            translationDiv.innerHTML = `
                <div class="translation-header">
                    <i class="fas fa-language"></i> Перевод:
                </div>
                <div class="translation-text">${data.translatedText}</div>
            `;

            // 7. Вставляем перевод после сообщения
            messageElement.appendChild(translationDiv);

            // 8. Меняем кнопку на "переведено"
            buttonElement.innerHTML = '<i class="fas fa-check"></i>';
            buttonElement.style.color = '#4CAF50'; // Зелёный цвет галочки

        } else {
            throw new Error('Перевод не удался');
        }

    } catch (error) {
        console.error('Ошибка перевода:', error);
        showNotification('Ошибка перевода. Сервис может быть недоступен.');
        // Возвращаем исходную иконку
        buttonElement.innerHTML = originalIcon;
    }
}
// Функция для запуска анимации конфетти
function startConfetti() {
    const confettiContainer = document.createElement('div');
    confettiContainer.style.position = 'fixed';
    confettiContainer.style.top = '0';
    confettiContainer.style.left = '0';
    confettiContainer.style.width = '100%';
    confettiContainer.style.height = '100%';
    confettiContainer.style.pointerEvents = 'none';
    confettiContainer.style.zIndex = '9999';
    document.body.appendChild(confettiContainer);

    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
    const emojis = ['🎉', '🎊', '⭐', '✨', '🎁', '🏆'];

    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'absolute';
        confetti.style.fontSize = Math.random() * 20 + 15 + 'px';
        confetti.style.opacity = '0';
        confetti.style.top = '-50px';
        confetti.style.left = Math.random() * 100 + 'vw';
        
        // Чередуем цветные точки и эмодзи
        if (Math.random() > 0.5) {
            confetti.style.width = '10px';
            confetti.style.height = '10px';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.borderRadius = '50%';
        } else {
            confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];
        }

        confettiContainer.appendChild(confetti);

        // Анимация падения
        const animation = confetti.animate([
            { 
                opacity: 0,
                transform: 'translateY(0) rotate(0deg)',
                top: '-50px'
            },
            { 
                opacity: 1,
                transform: `translateY(30vh) rotate(${Math.random() * 360}deg)`,
                top: '30vh'
            },
            { 
                opacity: 0,
                transform: `translateY(100vh) rotate(${Math.random() * 720}deg)`,
                top: '100vh'
            }
        ], {
            duration: Math.random() * 3000 + 2000,
            delay: Math.random() * 1000
        });

        animation.onfinish = () => {
            confetti.remove();
            if (confettiContainer.children.length === 0) {
                confettiContainer.remove();
            }
        };
    }
}

// Автоматически запускать конфетти для особых событий
function checkForSpecialEvents() {
    // При достижении нового уровня
    if (userLevel > parseInt(localStorage.getItem('lastLevel') || 0)) {
        startConfetti();
        localStorage.setItem('lastLevel', userLevel);
    }
    
    // При получении NFT подарка
    // Добавьте эту проверку в функцию отправки/получения подарков
}

// Вызывайте startConfetti() в нужных местах:
// - При достижении нового уровня
// - При получении особого подарка
// - При выполнении достижения
// Функция для обновления бейджа непрочитанных сообщений
function updateUnreadBadge() {
    const badge = document.getElementById('unreadPrivateBadge');
    if (badge) {
        if (unreadPrivateCount > 0) {
            badge.textContent = unreadPrivateCount;
            badge.style.display = 'flex';
            // Воспроизводим звук уведомления
            playNotificationSound();
        } else {
            badge.style.display = 'none';
        }
    }
}

// Функция для отслеживания новых приватных сообщений
function setupPrivateMessagesListener() {
    const privateChatsRef = database.ref('privateChats/' + userId);
    
    privateChatsRef.on('child_added', (snapshot) => {
        const chatData = snapshot.val();
        const chatUserId = snapshot.key;
        
        // Слушаем новые сообщения в этом чате
        const chatId = getPrivateChatId(userId, chatUserId);
        const messagesRef = database.ref('privateMessages/' + chatId);
        
        privateMessagesListeners[chatUserId] = messagesRef.orderByChild('timestamp')
            .startAt(Date.now())
            .on('child_added', (messageSnapshot) => {
                const message = messageSnapshot.val();
                
                // Если это не наше сообщение и мы не в этом чате
                if (message.userId !== userId && !isPrivateChatActive) {
                    unreadPrivateCount++;
                    updateUnreadBadge();
                    
                    // Показываем уведомление
                    showNotification(`Новое сообщение от ${message.name}`, 'private');
                }
            });
    });
}
// ★★★ УЛУЧШЕННАЯ СИСТЕМА ВЫБОРА АВАТАРКИ ★★★

// Инициализация улучшенного выбора аватарки
function initEnhancedAvatarSystem() {
    const avatarModalEnhanced = document.getElementById('avatarModalEnhanced');
    const closeEnhancedAvatarBtn = document.getElementById('closeEnhancedAvatarBtn');
    const saveEnhancedAvatarBtn = document.getElementById('saveEnhancedAvatarBtn');
    const avatarTabs = document.querySelectorAll('.avatar-tab');
    const avatarTabContents = document.querySelectorAll('.avatar-tab-content');
    const avatarFileInput = document.getElementById('avatarFileInput');
    const avatarUploadArea = document.getElementById('avatarUploadArea');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarPreviewImg = document.getElementById('avatarPreviewImg');
    const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
    const colorOptions = document.querySelectorAll('.color-option');
    const colorPreview = document.getElementById('colorPreview');
    const selectedColorText = document.getElementById('selectedColorText');
    
    let selectedAvatarType = 'default';
    let selectedAvatarValue = '';
    let uploadedAvatarFile = null;
    
    // Открытие модального окна
    function openEnhancedAvatarModal() {
        avatarModalEnhanced.classList.add('active');
        resetAvatarSelection();
    }
    
    // Закрытие модального окна
    function closeEnhancedAvatarModal() {
        avatarModalEnhanced.classList.remove('active');
    }
    
    // Сброс выбора
    function resetAvatarSelection() {
        selectedAvatarType = 'default';
        selectedAvatarValue = '';
        uploadedAvatarFile = null;
        
        // Сброс выбранных элементов
        document.querySelectorAll('.avatar-option.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        document.querySelectorAll('.color-option.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Скрытие превью
        avatarPreview.style.display = 'none';
        uploadAvatarBtn.disabled = true;
        
        // Сброс текста цвета
        colorPreview.style.backgroundColor = 'transparent';
        selectedColorText.textContent = 'Выберите цвет';
    }
    
    // Переключение вкладок
    avatarTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // Убираем активный класс у всех вкладок и контента
            avatarTabs.forEach(t => t.classList.remove('active'));
            avatarTabContents.forEach(c => c.classList.remove('active'));
            
            // Добавляем активный класс к выбранной вкладке и контенту
            tab.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            selectedAvatarType = tabId;
        });
    });
    
    // Выбор эмодзи-аватарки
    document.querySelectorAll('.avatar-option').forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            option.classList.add('selected');
            selectedAvatarValue = option.getAttribute('data-avatar');
            selectedAvatarType = 'default';
        });
    });
    
    // Выбор цвета
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            option.classList.add('selected');
            const color = option.getAttribute('data-color');
            selectedAvatarValue = color;
            
            // Обновление превью цвета
            colorPreview.style.backgroundColor = color;
            selectedColorText.textContent = color;
        });
    });
    
    // Загрузка файла
    avatarUploadArea.addEventListener('click', () => {
        avatarFileInput.click();
    });
    
    avatarUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        avatarUploadArea.style.borderColor = '#4facfe';
        avatarUploadArea.style.background = 'rgba(79, 172, 254, 0.2)';
    });
    
    avatarUploadArea.addEventListener('dragleave', () => {
        avatarUploadArea.style.borderColor = 'var(--border-color)';
        avatarUploadArea.style.background = 'transparent';
    });
    
    avatarUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        avatarUploadArea.style.borderColor = 'var(--border-color)';
        avatarUploadArea.style.background = 'transparent';
        
        if (e.dataTransfer.files.length > 0) {
            handleAvatarFile(e.dataTransfer.files[0]);
        }
    });
    
    avatarFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleAvatarFile(e.target.files[0]);
        }
    });
    
    function handleAvatarFile(file) {
        if (!file.type.startsWith('image/')) {
            showNotification('Пожалуйста, выберите изображение');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showNotification('Изображение должно быть меньше 5MB');
            return;
        }
        
        uploadedAvatarFile = file;
        
        // Показываем превью
        const reader = new FileReader();
        reader.onload = (e) => {
            avatarPreviewImg.src = e.target.result;
            avatarPreview.style.display = 'block';
            uploadAvatarBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }
    
    // Сохранение аватарки
    saveEnhancedAvatarBtn.addEventListener('click', saveEnhancedAvatar);
    
    function saveEnhancedAvatar() {
        if (selectedAvatarType === 'default' && selectedAvatarValue) {
            // Сохранение эмодзи
            userAvatarUrl = selectedAvatarValue;
            saveAvatarToStorageAndDB(selectedAvatarValue);
            closeEnhancedAvatarModal();
        } 
        else if (selectedAvatarType === 'colors' && selectedAvatarValue) {
            // Сохранение цвета
            userAvatarUrl = selectedAvatarValue;
            saveAvatarToStorageAndDB(selectedAvatarValue);
            closeEnhancedAvatarModal();
        }
        else if (selectedAvatarType === 'custom' && uploadedAvatarFile) {
            // Сохранение загруженного изображения
            const reader = new FileReader();
            reader.onload = (e) => {
                userAvatarUrl = e.target.result;
                saveAvatarToStorageAndDB(e.target.result);
                closeEnhancedAvatarModal();
            };
            reader.readAsDataURL(uploadedAvatarFile);
        }
        else {
            showNotification('Пожалуйста, выберите аватарку');
        }
    }
    
    function saveAvatarToStorageAndDB(avatar) {
        localStorage.setItem('quantumAvatar', avatar);
        
        // Обновляем отображение аватара
        updateAvatarDisplay();
        
        // Обновляем профиль в базе данных
        if (userId) {
            database.ref('profiles/' + userId).update({
                avatar: avatar
            });
        }
        
        showNotification("Аватарка обновлена! 🎉");
    }
    
    // Закрытие модального окна
    closeEnhancedAvatarBtn.addEventListener('click', closeEnhancedAvatarModal);
    
    // Закрытие при клике вне окна
    avatarModalEnhanced.addEventListener('click', (e) => {
        if (e.target === avatarModalEnhanced) {
            closeEnhancedAvatarModal();
        }
    });
    
    // Замена старой функции открытия аватарки
    const oldAvatarBtn = document.getElementById('avatarBtn');
    if (oldAvatarBtn) {
        oldAvatarBtn.addEventListener('click', openEnhancedAvatarModal);
    }
}

// Инициализация при загрузке
setTimeout(initEnhancedAvatarSystem, 1000);
    </script>
    <!-- Модальное окно настроек -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <h3>⚙️ Настройки Quantum Messenger</h3>
        
        <div class="settings-category">
            <h4>👤 Профиль</h4>
            <button class="settings-btn" onclick="document.getElementById('avatarModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-user-circle"></i> Сменить аватар
            </button>
            <button class="settings-btn" onclick="showStatusMenu(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-circle"></i> Изменить статус
            </button>
            <button class="settings-btn" onclick="showLevelInfo(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-chart-line"></i> Моя статистика
            </button>
        </div>
        
        <div class="settings-category">
            <h4>🎨 Внешний вид</h4>
            <button class="settings-btn" onclick="document.getElementById('themeModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-palette"></i> Сменить тему
            </button>
        </div>
        
        <div class="settings-category">
            <h4>🎮 Развлечения</h4>
            <button class="settings-btn" onclick="document.getElementById('giftModal').classList.add('active'); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-gift"></i> Отправить подарок
            </button>
            <button class="settings-btn" onclick="claimDailyReward(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-calendar-day"></i> Ежедневная награда
            </button>
            <button class="settings-btn" onclick="flipCoin(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-coins"></i> Бросить монетку
            </button>
            <button class="settings-btn" onclick="createPollModal(); document.getElementById('settingsModal').classList.remove('active');">
    <i class="fas fa-chart-bar"></i> Создать опрос
</button>
        </div>
        
        <div class="settings-category">
            <h4>⚡ Система</h4>
            <button class="settings-btn" onclick="clearChat(); document.getElementById('settingsModal').classList.remove('active');">
                <i class="fas fa-broom"></i> Очистить чат
            </button>
            <button class="settings-btn" onclick="document.getElementById('settingsModal').classList.remove('active'); showNotification('Уведомления включены!');">
                <i class="fas fa-bell"></i> Уведомления
            </button>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closeSettingsBtn">Закрыть</button>
        </div>
    </div>
</div>
    <!-- Модальное окно выбора темы -->
<div class="modal" id="themeModal">
    
    <div class="modal-content">
        <h3>Выберите тему</h3>
        <div class="theme-options">
            <div class="theme-option" data-theme="default">
                <div class="theme-preview default-theme"></div>
                <span>По умолчанию</span>
            </div>
            <div class="theme-option" data-theme="light-theme">
                <div class="theme-preview light-theme-preview"></div>
                <span>Светлая</span>
            </div>
            <div class="theme-option" data-theme="sea-theme">
                <div class="theme-preview sea-theme-preview"></div>
                <span>Морская</span>
            </div>
            <div class="theme-option" data-theme="halloween-theme">
                <div class="theme-preview halloween-theme-preview"></div>
                <span>Хэллоуин</span>
            </div>
            <div class="theme-option" data-theme="christmas-theme">
                <div class="theme-preview christmas-theme-preview"></div>
                <span>Новый Год</span>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closeThemeBtn">Закрыть</button>
        </div>
    </div>
</div>
<!-- Модальное окно улучшенного выбора аватарки -->
<div class="modal" id="avatarModalEnhanced">
    <div class="modal-content">
        <h3>Выберите аватарку</h3>
        
        <div class="avatar-tabs">
            <div class="avatar-tab active" data-tab="default">Эмодзи</div>
            <div class="avatar-tab" data-tab="custom">Загрузить своё</div>
            <div class="avatar-tab" data-tab="colors">Цвета</div>
        </div>
        
        <div class="avatar-tab-content active" id="tab-default">
            <div class="avatar-options-grid">
                <div class="avatar-option" data-avatar="😀">😀</div>
                <div class="avatar-option" data-avatar="😎">😎</div>
                <div class="avatar-option" data-avatar="🤖">🤖</div>
                <div class="avatar-option" data-avatar="🐱">🐱</div>
                <div class="avatar-option" data-avatar="🐶">🐶</div>
                <div class="avatar-option" data-avatar="🦊">🦊</div>
                <div class="avatar-option" data-avatar="🐻">🐻</div>
                <div class="avatar-option" data-avatar="🐼">🐼</div>
                <div class="avatar-option" data-avatar="🌻">🌻</div>
                <div class="avatar-option" data-avatar="🌵">🌵</div>
                <div class="avatar-option" data-avatar="🍕">🍕</div>
                <div class="avatar-option" data-avatar="🚀">🚀</div>
            </div>
        </div>
        
        <div class="avatar-tab-content" id="tab-custom">
            <div class="avatar-upload-container">
                <div class="avatar-upload-area" id="avatarUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Перетащите сюда изображение или нажмите для выбора</p>
                    <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                </div>
                <div class="avatar-preview" id="avatarPreview">
                    <img id="avatarPreviewImg" src="" alt="Предпросмотр">
                </div>
                <button class="modal-btn primary" id="uploadAvatarBtn" disabled>
                    <i class="fas fa-upload"></i> Загрузить аватарку
                </button>
            </div>
        </div>
        
        <div class="avatar-tab-content" id="tab-colors">
            <div class="color-options-grid">
                <div class="color-option" style="background: #4facfe;" data-color="#4facfe"></div>
                <div class="color-option" style="background: #00f2fe;" data-color="#00f2fe"></div>
                <div class="color-option" style="background: #a0d2eb;" data-color="#a0d2eb"></div>
                <div class="color-option" style="background: #7fdbda;" data-color="#7fdbda"></div>
                <div class="color-option" style="background: #6a9bd8;" data-color="#6a9bd8"></div>
                <div class="color-option" style="background: #ff6b6b;" data-color="#ff6b6b"></div>
                <div class="color-option" style="background: #ff9ff3;" data-color="#ff9ff3"></div>
                <div class="color-option" style="background: #feca57;" data-color="#feca57"></div>
                <div class="color-option" style="background: #48dbfb;" data-color="#48dbfb"></div>
                <div class="color-option" style="background: #1dd1a1;" data-color="#1dd1a1"></div>
                <div class="color-option" style="background: #00d2d3;" data-color="#00d2d3"></div>
                <div class="color-option" style="background: #54a0ff;" data-color="#54a0ff"></div>
            </div>
            <div class="selected-color-preview">
                <div class="color-preview" id="colorPreview"></div>
                <span id="selectedColorText">Выберите цвет</span>
            </div>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="closeEnhancedAvatarBtn">Отмена</button>
            <button class="modal-btn primary" id="saveEnhancedAvatarBtn">Сохранить</button>
        </div>
    </div>
</div>
<!-- Модальное окно выбора статуса -->
<div class="modal" id="statusModal">
    <div class="modal-content">
        <h3>Выберите статус</h3>
        <div class="status-menu">
            <div class="status-option" onclick="setUserStatus('online')">
                <div class="status-indicator online"></div>
                <span>Онлайн</span>
            </div>
            <div class="status-option" onclick="setUserStatus('away')">
                <div class="status-indicator away"></div>
                <span>Отошёл</span>
            </div>
            <div class="status-option" onclick="setUserStatus('busy')">
                <div class="status-indicator busy"></div>
                <span>Занят</span>
            </div>
            <div class="status-option" onclick="setUserStatus('dnd')">
                <div class="status-indicator dnd"></div>
                <span>Не беспокоить</span>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" onclick="document.getElementById('statusModal').classList.remove('active')">Закрыть</button>
        </div>
    </div>
</div>
<!-- Подключаем модальные окна каналов -->
    document.write('<script src="channels-modal.html"><\/script>');
</body>
</html>
